@model IEnumerable<booking.Models.Service>

@{
    ViewData["Title"] = "Quản lý dịch vụ";

    var fullName = User.FindFirst("FullName")?.Value;
    var displayName = string.IsNullOrWhiteSpace(fullName) ? (User.Identity?.Name ?? "bạn") : fullName;
    var now = DateTime.Now;

    // query
    var req = ViewContext.HttpContext.Request;
    var q = (req.Query["q"].ToString() ?? "").Trim();
    var active = (req.Query["active"].ToString() ?? "").Trim(); // "" | "1" | "0"
    var cat = (req.Query["cat"].ToString() ?? "").Trim();
    var sort = (req.Query["sort"].ToString() ?? "").Trim();     // newest|price_asc|price_desc

    // pagination (safe parse from ViewBag dynamic)
    int currentPage = 1, totalPages = 1, pageSize = 12, tmp;
    var pageStr = Convert.ToString((object?)ViewBag.Page);
    if (int.TryParse(pageStr, out tmp)) currentPage = Math.Max(1, tmp);
    var totalPagesStr = Convert.ToString((object?)ViewBag.TotalPages);
    if (int.TryParse(totalPagesStr, out tmp)) totalPages = Math.Max(1, tmp);
    var pageSizeStr = Convert.ToString((object?)ViewBag.PageSize);
    if (int.TryParse(pageSizeStr, out tmp)) pageSize = Math.Max(1, tmp);

    string Qs(int p)
    {
        var parts = new List<string>();
        if (!string.IsNullOrWhiteSpace(q)) parts.Add("q=" + Uri.EscapeDataString(q));
        if (!string.IsNullOrWhiteSpace(active)) parts.Add("active=" + Uri.EscapeDataString(active));
        if (!string.IsNullOrWhiteSpace(cat)) parts.Add("cat=" + Uri.EscapeDataString(cat));
        if (!string.IsNullOrWhiteSpace(sort)) parts.Add("sort=" + Uri.EscapeDataString(sort));
        parts.Add("page=" + p);
        return "?" + string.Join("&", parts);
    }

    string Badge(bool isActive) =>
        isActive ? "bg-emerald-100 text-emerald-800 ring-1 ring-emerald-200"
                 : "bg-slate-100 text-slate-800 ring-1 ring-slate-200";

    // clamp description
    string ClampText(string? s, int max = 140)
    {
        s = (s ?? "").Trim();
        if (s.Length <= max) return s;
        return s.Substring(0, max) + "…";
    }

    // category list (dropdown options)
    var categories = (Model ?? Enumerable.Empty<booking.Models.Service>())
        .Select(x => x.Category)
        .Where(x => !string.IsNullOrWhiteSpace(x))
        .Distinct()
        .OrderBy(x => x)
        .ToList();
}

<div class="min-h-screen bg-slate-50">
    <div class="mx-auto max-w-7xl px-4 py-8 sm:py-10">

        <!-- Header -->
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
                <div class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600 shadow-sm">
                    <span class="h-2 w-2 rounded-full bg-indigo-500"></span>
                    Business Portal
                </div>

                <h1 class="mt-3 text-2xl font-extrabold tracking-tight text-slate-900 sm:text-3xl">
                    Quản lý dịch vụ
                </h1>

                <p class="mt-2 text-sm text-slate-600">
                    Xin chào <span class="font-semibold text-slate-900">@displayName</span> •
                    <span class="text-slate-500">Cập nhật lúc</span>
                    <span class="font-semibold text-slate-700">@now.ToString("HH:mm")</span>
                </p>
            </div>

            <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                <a asp-controller="Business" asp-action="index"
                   class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50">
                    ← Về dashboard
                </a>

                <a asp-controller="BusinessServices" asp-action="Create"
                   class="inline-flex items-center justify-center rounded-2xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-indigo-700">
                    + Tạo dịch vụ mới
                </a>
            </div>
        </div>

        <!-- Filters -->
        <div class="mt-6 rounded-3xl border border-slate-200 bg-white p-5 shadow-sm">
            <form method="get" class="grid grid-cols-1 gap-3 sm:grid-cols-12 sm:items-end">
                <div class="sm:col-span-5">
                    <div class="text-sm font-semibold text-slate-900">Tìm dịch vụ</div>
                    <input name="q" value="@q"
                           class="mt-2 h-11 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm text-slate-700 shadow-sm
                                  focus:outline-none focus:ring-2 focus:ring-indigo-300"
                           placeholder="Tên dịch vụ / địa điểm..." />
                </div>

                <div class="sm:col-span-3">
                    <div class="text-sm font-semibold text-slate-900">Danh mục</div>
                    <select name="cat"
                            class="mt-2 h-11 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm font-semibold text-slate-700 shadow-sm
                                   focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        <option value="" selected="@(string.IsNullOrWhiteSpace(cat))">Tất cả</option>
                        @foreach (var c in categories)
                        {
                            <option value="@c" selected="@(cat == c)">@c</option>
                        }
                    </select>
                </div>

                <div class="sm:col-span-2">
                    <div class="text-sm font-semibold text-slate-900">Trạng thái</div>
                    <select name="active"
                            class="mt-2 h-11 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm font-semibold text-slate-700 shadow-sm
                                   focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        <option value="" selected="@(string.IsNullOrWhiteSpace(active))">Tất cả</option>
                        <option value="1" selected="@(active == "1")">Đang bật</option>
                        <option value="0" selected="@(active == "0")">Tạm dừng</option>
                    </select>
                </div>

                <div class="sm:col-span-2">
                    <div class="text-sm font-semibold text-slate-900">Sắp xếp</div>
                    <select name="sort"
                            class="mt-2 h-11 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm font-semibold text-slate-700 shadow-sm
                                   focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        <option value="" selected="@(string.IsNullOrWhiteSpace(sort))">Mặc định</option>
                        <option value="newest" selected="@(sort == "newest")">Mới nhất</option>
                        <option value="price_asc" selected="@(sort == "price_asc")">Giá tăng</option>
                        <option value="price_desc" selected="@(sort == "price_desc")">Giá giảm</option>
                    </select>
                </div>

                <div class="sm:col-span-12 flex gap-2 justify-end">
                    <button type="submit"
                            class="inline-flex h-11 items-center justify-center rounded-2xl bg-slate-900 px-4 text-sm font-semibold text-white shadow-sm hover:bg-slate-800">
                        Áp dụng
                    </button>
                    <a asp-controller="BusinessServices" asp-action="Index"
                       class="inline-flex h-11 items-center justify-center rounded-2xl border border-slate-200 bg-white px-4 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50">
                        Reset
                    </a>
                </div>
            </form>
        </div>

        <!-- Grid -->
        <div class="mt-6">
            @if (Model == null || !Model.Any())
            {
                <div class="rounded-3xl border border-slate-200 bg-white p-8 text-center shadow-sm">
                    <div class="text-lg font-extrabold text-slate-900">Chưa có dịch vụ nào</div>
                    <div class="mt-2 text-sm text-slate-600">Tạo dịch vụ để bắt đầu nhận lịch hẹn.</div>
                    <div class="mt-5">
                        <a asp-controller="BusinessServices" asp-action="Create"
                           class="inline-flex items-center justify-center rounded-2xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-indigo-700">
                            + Tạo dịch vụ mới
                        </a>
                    </div>
                </div>
            }
            else
            {
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                    @foreach (var s in Model)
                    {
                        var thumb = !string.IsNullOrWhiteSpace(s.Thumbnail)
                            ? s.Thumbnail
                            : "/images/placeholder-service.png";

                        <div class="rounded-3xl border border-slate-200 bg-white p-5 shadow-sm">

                            <!-- ✅ Ảnh dịch vụ -->
                            <a asp-controller="BusinessServices" asp-action="Edit" asp-route-id="@s.Id"
                               class="mb-4 block overflow-hidden rounded-2xl border border-slate-200">
                                <img src="@thumb"
                                     alt="@s.Name"
                                     class="h-40 w-full object-cover" />
                            </a>

                            <div class="flex items-start justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="truncate text-lg font-extrabold text-slate-900">@s.Name</div>
                                    <div class="mt-1 text-sm text-slate-600">
                                        @s.Category • @s.DurationMinutes phút
                                    </div>
                                </div>
                                <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-bold @Badge(s.IsActive)">
                                    @(s.IsActive ? "Đang bật" : "Tạm dừng")
                                </span>
                            </div>

                            <div class="mt-3 text-sm text-slate-700">
                                Giá: <span class="font-semibold text-slate-900">@s.Price.ToString("N0")đ</span>
                            </div>

                            <div class="mt-2 text-xs text-slate-500">
                                Rating: <span class="font-semibold text-slate-700">@s.Rating.ToString("0.0")</span>
                                • Review: <span class="font-semibold text-slate-700">@s.ReviewCount</span>
                            </div>

                            <div class="mt-2 text-xs text-slate-500">
                                Địa điểm: <span class="font-semibold text-slate-700">@(string.IsNullOrWhiteSpace(s.Location) ? "—" : s.Location)</span>
                            </div>

                            @if (!string.IsNullOrWhiteSpace(s.Description))
                            {
                                <div class="mt-3 text-sm text-slate-600 leading-relaxed">
                                    @ClampText(s.Description, 140)
                                </div>
                            }
                            else
                            {
                                <div class="mt-3 text-sm text-slate-400">
                                    Chưa có mô tả.
                                </div>
                            }

                            <div class="mt-4 flex flex-wrap gap-2">
                                <a asp-controller="BusinessServices" asp-action="Edit" asp-route-id="@s.Id"
                                   class="inline-flex h-10 items-center justify-center rounded-xl border border-slate-200 bg-white px-3 text-xs font-bold text-slate-700 shadow-sm hover:bg-slate-50">
                                    Sửa
                                </a>

                                <form asp-controller="BusinessServices" asp-action="Toggle" method="post" class="inline-block">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@s.Id" />
                                    <input type="hidden" name="returnUrl" value="@($"{ViewContext.HttpContext.Request.Path}{ViewContext.HttpContext.Request.QueryString}")" />
                                    <button type="submit"
                                            class="inline-flex h-10 items-center justify-center rounded-xl px-3 text-xs font-bold text-white shadow-sm
                                                   @(s.IsActive ? "bg-slate-900 hover:bg-slate-800" : "bg-emerald-600 hover:bg-emerald-700")">
                                        @(s.IsActive ? "Tạm dừng" : "Kích hoạt")
                                    </button>
                                </form>

                                <form asp-controller="BusinessServices" asp-action="Delete" method="post" class="inline-block js-delete-form">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@s.Id" />
                                    <input type="hidden" name="returnUrl" value="@($"{ViewContext.HttpContext.Request.Path}{ViewContext.HttpContext.Request.QueryString}")" />

                                    <button type="submit"
                                            data-name="@s.Name"
                                            class="inline-flex h-10 items-center justify-center rounded-xl bg-rose-600 px-3 text-xs font-bold text-white shadow-sm hover:bg-rose-700">
                                        Xoá
                                    </button>
                                </form>
                            </div>
                        </div>
                    }
                </div>

                @if (totalPages > 1)
                {
                    var start = Math.Max(1, currentPage - 2);
                    var end = Math.Min(totalPages, currentPage + 2);

                    <div class="mt-6 flex flex-col items-center justify-between gap-3 rounded-3xl border border-slate-200 bg-white px-6 py-4 shadow-sm sm:flex-row">
                        <div class="text-sm text-slate-600">
                            Trang <span class="font-semibold text-slate-900">@currentPage</span> /
                            <span class="font-semibold text-slate-900">@totalPages</span>
                            • Mỗi trang <span class="font-semibold text-slate-900">@pageSize</span> mục
                        </div>

                        <div class="flex flex-wrap items-center gap-2">
                            <a href="@Qs(Math.Max(1, currentPage - 1))"
                               class="inline-flex h-10 items-center justify-center rounded-xl border border-slate-200 bg-white px-3 text-xs font-bold text-slate-700 shadow-sm hover:bg-slate-50 @(currentPage <= 1 ? "pointer-events-none opacity-50" : "")">
                                ← Trước
                            </a>

                            @for (int p = start; p <= end; p++)
                            {
                                var isCurrent = (p == currentPage);
                                <a href="@Qs(p)"
                                   class="inline-flex h-10 min-w-[40px] items-center justify-center rounded-xl px-3 text-xs font-extrabold shadow-sm
                                          @(isCurrent ? "bg-indigo-600 text-white" : "border border-slate-200 bg-white text-slate-700 hover:bg-slate-50")">
                                    @p
                                </a>
                            }

                            <a href="@Qs(Math.Min(totalPages, currentPage + 1))"
                               class="inline-flex h-10 items-center justify-center rounded-xl border border-slate-200 bg-white px-3 text-xs font-bold text-slate-700 shadow-sm hover:bg-slate-50 @(currentPage >= totalPages ? "pointer-events-none opacity-50" : "")">
                                Sau →
                            </a>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            document.querySelectorAll(".js-delete-form").forEach(f => {
                f.addEventListener("submit", function (e) {
                    e.preventDefault();

                    const btn = f.querySelector("button[type='submit']");
                    const name = btn?.getAttribute("data-name") || "dịch vụ này";

                    Swal.fire({
                        icon: "warning",
                        title: "Xoá dịch vụ?",
                        text: `Bạn chắc chắn muốn xoá "${name}" không?`,
                        showCancelButton: true,
                        confirmButtonText: "Xoá",
                        cancelButtonText: "Hủy",
                        reverseButtons: true
                    }).then((r) => {
                        if (r.isConfirmed) f.submit();
                    });
                });
            });
        })();
    </script>
}
