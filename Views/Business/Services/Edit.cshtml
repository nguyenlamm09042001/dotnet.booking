@model booking.Models.Service
@{
    ViewData["Title"] = "Sửa dịch vụ";
}

<div class="min-h-screen bg-gradient-to-b from-slate-50 to-white">
  <div class="mx-auto max-w-4xl px-4 py-10">

    <!-- Header -->
    <div class="mb-6">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <div class="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1 text-xs font-semibold text-slate-600 ring-1 ring-slate-200">
            <span class="h-2 w-2 rounded-full bg-indigo-500"></span>
            Business Services
          </div>

          <h1 class="mt-3 text-2xl font-extrabold tracking-tight text-slate-900 sm:text-3xl">
            Sửa dịch vụ
          </h1>
          <p class="mt-1 text-sm text-slate-600">
            Cập nhật thông tin dịch vụ.
          </p>
        </div>

        <div class="flex items-center gap-2">
          <a asp-controller="BusinessServices" asp-action="Index"
             class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50">
            ← Quay lại
          </a>
        </div>
      </div>
    </div>

    <!-- Main grid -->
    <div class="grid grid-cols-1 gap-6 lg:grid-cols-12">

      <!-- Form card -->
      <div class="lg:col-span-8 rounded-3xl border border-slate-200 bg-white shadow-sm">
        <div class="border-b border-slate-200 px-6 py-5">
          <div class="text-lg font-extrabold text-slate-900">Chỉnh sửa dịch vụ</div>
          <div class="mt-1 text-sm text-slate-600">Thay thumbnail, cập nhật mô tả, giá và trạng thái.</div>
        </div>

        <!-- ✅ enctype để upload -->
        <form id="serviceEditForm"
              asp-action="Edit"
              method="post"
              enctype="multipart/form-data"
              class="px-6 py-6 space-y-6">

          @Html.AntiForgeryToken()
          <input type="hidden" asp-for="Id" />

          <!-- ✅ show lỗi tổng -->
          <div class="text-sm text-rose-600">
            @Html.ValidationSummary()
          </div>

          <!-- ✅ Thumbnail -->
          <div class="rounded-3xl border border-slate-200 bg-slate-50 p-5">
            <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <div class="text-sm font-extrabold text-slate-900">Ảnh dịch vụ (thumbnail)</div>
                <div class="mt-1 text-xs text-slate-600">JPG/PNG/WEBP, tối đa 3MB.</div>
                <div class="mt-2 rounded-2xl bg-white p-3 ring-1 ring-slate-200">
                  <div class="text-xs font-semibold text-slate-500">Ảnh hiện tại</div>
                  <div class="mt-1 break-all text-xs text-slate-700">
                    @(string.IsNullOrWhiteSpace(Model.Thumbnail) ? "—" : Model.Thumbnail)
                  </div>
                </div>
              </div>

              <div class="flex items-center gap-4">
                <div class="relative">
                  <img id="thumbPreview"
                       src="@(string.IsNullOrWhiteSpace(Model.Thumbnail) ? Url.Content("~/images/placeholder-service.png") : Url.Content(Model.Thumbnail))"
                       class="h-20 w-20 rounded-2xl object-cover ring-4 ring-white shadow-sm border border-slate-200"
                       onerror="this.onerror=null;this.src='@Url.Content("~/images/placeholder-service.png")';" />
                  <div class="absolute -bottom-2 -right-2 rounded-full bg-white p-1 shadow ring-1 ring-slate-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-700" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M9 2a1 1 0 0 0-1 1v1H6.414a2 2 0 0 0-1.414.586L3.586 6A2 2 0 0 0 3 7.414V19a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3V7.414a2 2 0 0 0-.586-1.414L19 4.586A2 2 0 0 0 17.586 4H16V3a1 1 0 0 0-1-1H9zm7 4h1.586l1.414 1.414V9h-2.126a3.001 3.001 0 0 0-5.748 0H9.126a3.001 3.001 0 0 0-5.748 0H3V7.414L4.414 6H6v1a1 1 0 0 0 2 0V6h8v1a1 1 0 0 0 2 0V6zM12 11a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm-5 8a5 5 0 1 1 10 0H7z"/>
                    </svg>
                  </div>
                </div>

                <div class="flex flex-col gap-2">
                  <!-- ⚠️ name phải đúng: thumbFile -->
                  <label class="inline-flex cursor-pointer items-center justify-center rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50">
                    Chọn ảnh mới
                    <input id="thumbFileInput"
                           type="file"
                           name="thumbFile"
                           accept="image/*"
                           class="hidden" />
                  </label>

                  <button type="button" id="btnClearThumb"
                          class="inline-flex items-center justify-center rounded-2xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-800">
                    Xoá chọn
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Fields -->
          <div class="grid grid-cols-1 gap-5 sm:grid-cols-2">

            <!-- Name -->
            <div class="sm:col-span-2">
              <label class="text-sm font-semibold text-slate-700">Tên dịch vụ</label>
              <div class="mt-2 relative">
                <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm0 4a3 3 0 1 1-3 3 3 3 0 0 1 3-3Zm0 14a7.966 7.966 0 0 1-5.5-2.2 4.5 4.5 0 0 1 9 0A7.966 7.966 0 0 1 12 20Z"/>
                  </svg>
                </span>

                <input asp-for="Name"
                       class="h-11 w-full rounded-2xl border border-slate-200 bg-white pl-10 pr-3 text-sm text-slate-900
                              placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-indigo-300" />
              </div>
              <span asp-validation-for="Name" class="mt-1 block text-xs text-rose-600"></span>
            </div>

            <!-- Category -->
            <div>
              <label class="text-sm font-semibold text-slate-700">Danh mục</label>
              <input asp-for="Category"
                     class="mt-2 h-11 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm text-slate-900
                            focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-indigo-300" />
              <span asp-validation-for="Category" class="mt-1 block text-xs text-rose-600"></span>
            </div>

            <!-- Location -->
            <div>
              <label class="text-sm font-semibold text-slate-700">Địa điểm</label>
              <input asp-for="Location"
                     class="mt-2 h-11 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm text-slate-900
                            focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-indigo-300" />
              <span asp-validation-for="Location" class="mt-1 block text-xs text-rose-600"></span>
            </div>

            <!-- Description -->
            <div class="sm:col-span-2">
              <label class="text-sm font-semibold text-slate-700">Mô tả</label>
              <textarea asp-for="Description" rows="4"
                        class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900
                               focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-indigo-300"></textarea>
              <span asp-validation-for="Description" class="mt-1 block text-xs text-rose-600"></span>
            </div>

            <!-- Price -->
            <div>
              <label class="text-sm font-semibold text-slate-700">Giá (VND)</label>
              <input asp-for="Price"
                     class="mt-2 h-11 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm text-slate-900
                            focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-indigo-300" />
              <span asp-validation-for="Price" class="mt-1 block text-xs text-rose-600"></span>
            </div>

            <!-- Duration -->
            <div>
              <label class="text-sm font-semibold text-slate-700">Thời lượng (phút)</label>
              <input asp-for="DurationMinutes"
                     class="mt-2 h-11 w-full rounded-2xl border border-slate-200 bg-white px-3 text-sm text-slate-900
                            focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-indigo-300" />
              <span asp-validation-for="DurationMinutes" class="mt-1 block text-xs text-rose-600"></span>
            </div>

            <!-- Active -->
            <div class="flex items-end gap-3 sm:col-span-2">
              <input asp-for="IsActive"
                     class="h-5 w-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-300" />
              <label class="text-sm font-semibold text-slate-700">Đang hoạt động</label>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex flex-col gap-3 border-t border-slate-200 pt-5 sm:flex-row sm:items-center sm:justify-between">
            <div class="text-xs text-slate-500">
              * Thay ảnh xong nhớ bấm “Lưu thay đổi”.
            </div>

            <div class="flex items-center gap-2 justify-end">
              <button type="button" id="btnCancel"
                      class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white px-5 py-3
                             text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50">
                Hủy
              </button>

              <button type="submit"
                      class="inline-flex items-center justify-center rounded-2xl bg-slate-900 px-5 py-3
                             text-sm font-semibold text-white shadow-sm hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-300">
                Lưu thay đổi
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Side card -->
      <div class="lg:col-span-4 space-y-6">
        <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
          <div class="text-sm font-extrabold text-slate-900">Gợi ý cập nhật</div>
          <div class="mt-2 space-y-2 text-sm text-slate-600">
            <div class="flex gap-2">
              <span class="mt-1 h-2 w-2 rounded-full bg-indigo-500"></span>
              <div>Đổi tên rõ ràng giúp khách dễ chọn dịch vụ hơn.</div>
            </div>
            <div class="flex gap-2">
              <span class="mt-1 h-2 w-2 rounded-full bg-amber-500"></span>
              <div>Giá & thời lượng đúng giúp hệ thống chia slot chuẩn.</div>
            </div>
            <div class="flex gap-2">
              <span class="mt-1 h-2 w-2 rounded-full bg-emerald-500"></span>
              <div>Nếu tắt “Đang hoạt động”, dịch vụ sẽ ẩn khỏi trang khách.</div>
            </div>
          </div>
        </div>

        <div class="rounded-3xl border border-slate-200 bg-gradient-to-br from-indigo-50 to-white p-6 shadow-sm">
          <div class="text-sm font-extrabold text-slate-900">Nhắc nhỏ</div>
          <div class="mt-2 text-sm text-slate-700">
            Nếu ảnh vẫn không đổi, thử hard refresh (Cmd+Shift+R).
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

@section Scripts {
  <partial name="_ValidationScriptsPartial" />

  <script>
    // preview + clear thumbnail + validate size (3MB)
    const f = document.getElementById('thumbFileInput');
    const img = document.getElementById('thumbPreview');
    const btnClear = document.getElementById('btnClearThumb');
    const btnCancel = document.getElementById('btnCancel');
    const form = document.getElementById('serviceEditForm');

    const originalSrc = img ? img.getAttribute('src') : null;

    if (f && img) {
      f.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        const maxBytes = 3 * 1024 * 1024;
        if (file.size > maxBytes) {
          Swal.fire({
            icon: 'warning',
            title: 'File quá lớn',
            text: 'Vui lòng chọn ảnh tối đa 3MB.'
          });
          f.value = '';
          if (originalSrc) img.src = originalSrc;
          return;
        }

        img.src = URL.createObjectURL(file);
      });
    }

    if (btnClear && f && img) {
      btnClear.addEventListener('click', () => {
        f.value = '';
        if (originalSrc) img.src = originalSrc;
      });
    }

    // cancel -> confirm back
    if (btnCancel) {
      btnCancel.addEventListener('click', () => {
        Swal.fire({
          icon: 'question',
          title: 'Hủy chỉnh sửa?',
          text: 'Các thay đổi chưa lưu sẽ bị mất.',
          showCancelButton: true,
          confirmButtonText: 'Rời trang',
          cancelButtonText: 'Ở lại',
          reverseButtons: true
        }).then((r) => {
          if (r.isConfirmed) {
            window.location.href = '@Url.Action("Index", "BusinessServices")';
          }
        });
      });
    }

    // confirm submit
    if (form) {
      form.addEventListener('submit', function (ev) {
        ev.preventDefault();

        Swal.fire({
          icon: 'question',
          title: 'Lưu thay đổi?',
          text: 'Bạn có chắc muốn cập nhật dịch vụ này không?',
          showCancelButton: true,
          confirmButtonText: 'Lưu',
          cancelButtonText: 'Hủy',
          reverseButtons: true,
          confirmButtonColor: '#0f172a'
        }).then((result) => {
          if (result.isConfirmed) form.submit();
        });
      });
    }

    // swal từ TempData (nếu controller có set)
    @if (TempData["SwalType"] != null)
    {
      <text>
      Swal.fire({
        icon: '@TempData["SwalType"]',
        title: '@TempData["SwalTitle"]',
        text: '@TempData["SwalMessage"]'
      });
      </text>
    }
  </script>
}
