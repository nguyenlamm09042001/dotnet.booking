@model booking.ViewModels.AdminDashboardVm

@{
    ViewData["Title"] = "Bảng điều khiển quản trị";
    var now = DateTime.Now;

    string BizBadge(string? st)
    {
        st = (st ?? "pending").Trim().ToLower();
        return st switch
        {
            "pending" => "inline-flex items-center rounded-full bg-amber-100 px-3 py-1 text-xs font-bold text-amber-700 ring-1 ring-amber-200",
            "active" => "inline-flex items-center rounded-full bg-emerald-100 px-3 py-1 text-xs font-bold text-emerald-700 ring-1 ring-emerald-200",
            "suspended" => "inline-flex items-center rounded-full bg-slate-200 px-3 py-1 text-xs font-bold text-slate-700 ring-1 ring-slate-300",
            "rejected" => "inline-flex items-center rounded-full bg-rose-100 px-3 py-1 text-xs font-bold text-rose-700 ring-1 ring-rose-200",
            _ => "inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-bold text-slate-700 ring-1 ring-slate-200"
        };
    }

    string BizText(string? st)
    {
        st = (st ?? "pending").Trim().ToLower();
        return st switch
        {
            "pending" => "Chờ duyệt",
            "active" => "Đang hoạt động",
            "suspended" => "Tạm khóa",
            "rejected" => "Từ chối",
            _ => st ?? ""
        };
    }
}

<div class="min-h-screen bg-white text-slate-900">
    <!-- Thanh trên -->
    <header class="sticky top-0 z-40 border-b border-slate-200 bg-white/80 backdrop-blur">
        <div class="mx-auto max-w-7xl px-4">
            <div class="flex h-16 items-center justify-between gap-3">
                <!-- Thương hiệu -->
                <div class="flex items-center gap-3">
                    <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-slate-100 ring-1 ring-slate-200">
                        <span class="text-sm font-black tracking-tight text-slate-900">ADM</span>
                    </div>
                    <div class="leading-tight">
                        <div class="text-sm font-extrabold tracking-wide text-slate-900">BẢNG ĐIỀU KHIỂN QUẢN TRỊ</div>
                        <div class="text-xs text-slate-500">Tổng quan hệ thống • @now.ToString("dd/MM/yyyy HH:mm")</div>
                    </div>
                </div>

                <div class="hidden w-full max-w-xl items-center gap-2 md:flex">
                    <form asp-controller="AdminUsers" asp-action="Index" method="get" class="flex w-full items-center gap-2">
                        <div class="relative w-full">
                            <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M10 2a8 8 0 105.293 14.293l4.707 4.707 1.414-1.414-4.707-4.707A8 8 0 0010 2zm0 2a6 6 0 110 12 6 6 0 010-12z"/>
                                </svg>
                            </span>

                            <input type="text"
                                   name="q"
                                   value="@(ViewBag.Q ?? "")"
                                   class="h-11 w-full rounded-2xl border border-slate-300 bg-white pl-10 pr-3 text-sm text-slate-900 placeholder:text-slate-400
                                          focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Tìm theo tên, email, role, ID…" />
                        </div>

                        <button type="submit"
                                class="inline-flex h-11 items-center justify-center rounded-2xl border border-slate-300 bg-white px-4 text-sm font-semibold text-slate-900
                                       hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            Tìm
                        </button>

                        <a asp-controller="Admin" asp-action="Index"
                           class="inline-flex h-11 items-center justify-center rounded-2xl border border-slate-300 bg-white px-4 text-sm font-semibold text-slate-900
                                  hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            Dashboard
                        </a>
                    </form>
                </div>

                <!-- Hành động -->
                <div class="flex items-center gap-2">
                    <button type="button"
                            class="inline-flex h-11 items-center justify-center rounded-2xl border border-slate-300 bg-white px-3
                                   text-sm font-semibold text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            aria-label="Thông báo">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 22a2.5 2.5 0 002.45-2h-4.9A2.5 2.5 0 0012 22zm7-6V11a7 7 0 00-5-6.71V3a2 2 0 10-4 0v1.29A7 7 0 005 11v5l-2 2v1h18v-1l-2-2z"/>
                        </svg>
                    </button>

                    <form asp-controller="Account" asp-action="Logout" method="post" class="inline-block">
                        @Html.AntiForgeryToken()
                        <button type="submit"
                                class="inline-flex h-11 items-center justify-center rounded-2xl bg-rose-600 px-4 text-sm font-semibold text-white
                                       hover:bg-rose-700 focus:outline-none focus:ring-2 focus:ring-rose-400">
                            Đăng xuất
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </header>

    <div class="mx-auto max-w-7xl px-4 py-8">
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-12">

            <!-- Thanh bên -->
            <aside class="lg:col-span-3">
                <div class="rounded-3xl border border-slate-200 bg-white p-4 shadow-sm">
                    <div class="text-xs font-bold uppercase tracking-wider text-slate-500">Điều hướng</div>

                    <nav class="mt-4 space-y-2">
                        <a asp-controller="Admin" asp-action="Index"
                           class="flex items-center justify-between rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-semibold text-slate-900 hover:bg-slate-100">
                            <span>Bảng điều khiển</span>
                            <span class="text-slate-400">↩</span>
                        </a>

                        <a asp-controller="AdminBusinesses" asp-action="Index"
                           class="flex items-center justify-between rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-700 hover:bg-slate-50">
                            <span>Doanh nghiệp</span>
                            <span class="text-slate-400">→</span>
                        </a>

                        <a asp-controller="AdminUsers" asp-action="Index"
                           class="flex items-center justify-between rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-700 hover:bg-slate-50">
                            <span>Người dùng</span>
                            <span class="text-slate-400">→</span>
                        </a>

                        <button type="button"
                                class="flex w-full items-center justify-between rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-700 hover:bg-slate-50">
                            <span>Nhật ký kiểm tra</span>
                            <span class="text-slate-400">↗</span>
                        </button>

                        <button type="button"
                                class="flex w-full items-center justify-between rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-700 hover:bg-slate-50">
                            <span>Cài đặt hệ thống</span>
                            <span class="text-slate-400">↗</span>
                        </button>
                    </nav>

                    <div class="mt-5 rounded-2xl border border-slate-200 bg-slate-50 p-4">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <div class="text-sm font-bold text-slate-900">Trạng thái hệ thống</div>
                                <div class="mt-1 text-sm text-slate-600">Tất cả dịch vụ đang hoạt động</div>
                            </div>
                            <span class="inline-flex items-center rounded-full bg-emerald-100 px-3 py-1 text-xs font-bold text-emerald-700 ring-1 ring-emerald-200">
                                OK
                            </span>
                        </div>

                        <div class="mt-3 text-sm text-slate-600">
                            Cảnh báo: <span class="font-semibold text-slate-900">@Model.SystemAlerts</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Nội dung chính -->
            <main class="lg:col-span-9 space-y-6">

                <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                        <div>
                            <h1 class="text-2xl font-extrabold tracking-tight text-slate-900">Bảng điều khiển quản trị</h1>
                            <p class="mt-1 text-sm text-slate-600">
                                Trung tâm điều hành cho người dùng & doanh nghiệp • theo dõi thời gian thực
                            </p>
                        </div>

                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                            <a asp-controller="AdminBusinesses" asp-action="Index"
                               class="inline-flex h-11 items-center justify-center rounded-2xl bg-indigo-600 px-4 text-sm font-semibold text-white
                                      hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                Sang Doanh nghiệp →
                            </a>

                            <a asp-controller="AdminUsers" asp-action="Index"
                               class="inline-flex h-11 items-center justify-center rounded-2xl border border-slate-300 bg-white px-4 text-sm font-semibold text-slate-900
                                      hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                Sang Người dùng
                            </a>
                        </div>
                    </div>
                </div>

                <!-- KPI -->
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
                    <div class="rounded-3xl border border-slate-200 bg-white p-5 shadow-sm">
                        <div class="text-xs font-bold uppercase tracking-wider text-slate-500">Tổng người dùng</div>
                        <div class="mt-2 text-3xl font-extrabold text-slate-900">@Model.TotalUsers</div>
                        <div class="mt-2 text-sm text-slate-600">
                            Mới (7 ngày): <span class="font-semibold text-emerald-700">+@Model.NewUsers7d</span>
                        </div>
                    </div>

                    <div class="rounded-3xl border border-slate-200 bg-white p-5 shadow-sm">
                        <div class="text-xs font-bold uppercase tracking-wider text-slate-500">Tổng doanh nghiệp</div>
                        <div class="mt-2 text-3xl font-extrabold text-slate-900">@Model.TotalBusinesses</div>
                        <div class="mt-2 text-sm text-slate-600">Đã đăng ký trong hệ thống</div>
                    </div>

                    <div class="rounded-3xl border border-amber-200 bg-amber-50 p-5 shadow-sm">
                        <div class="text-xs font-bold uppercase tracking-wider text-amber-700">Chờ phê duyệt</div>
                        <div class="mt-2 text-3xl font-extrabold text-slate-900">@Model.PendingBusinesses</div>
                        <div class="mt-2 text-sm text-amber-700/80">Cần xem xét & phê duyệt</div>
                    </div>

                    <div class="rounded-3xl border border-slate-200 bg-white p-5 shadow-sm">
                        <div class="text-xs font-bold uppercase tracking-wider text-slate-500">Doanh nghiệp đang hoạt động</div>
                        <div class="mt-2 text-3xl font-extrabold text-slate-900">@Model.ActiveBusinesses</div>
                        <div class="mt-2 text-sm text-slate-600">Đang vận hành</div>
                    </div>
                </div>

                <!-- Lưới vận hành -->
                <div class="grid grid-cols-1 gap-6 lg:grid-cols-12">
                    <!-- Pending businesses thật -->
                    <section class="lg:col-span-7 rounded-3xl border border-slate-200 bg-white shadow-sm">
                        <div class="flex flex-col gap-3 px-6 py-5 sm:flex-row sm:items-center sm:justify-between">
                            <div>
                                <div class="text-lg font-extrabold text-slate-900">Hàng đợi phê duyệt • Doanh nghiệp</div>
                                <div class="mt-1 text-sm text-slate-600">Các doanh nghiệp pending mới nhất</div>
                            </div>

                            <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                                <form asp-controller="AdminBusinesses" asp-action="BulkApproveLowRisk" method="post" class="flex items-center gap-2">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="cap" value="200" />
                                    <button type="submit"
                                            class="inline-flex h-11 items-center justify-center rounded-2xl bg-emerald-600 px-4 text-sm font-semibold text-white hover:bg-emerald-700
                                                   focus:outline-none focus:ring-2 focus:ring-emerald-400">
                                        Duyệt low-risk (200)
                                    </button>
                                </form>

                                <a asp-controller="AdminBusinesses" asp-action="Index"
                                   class="inline-flex h-11 items-center justify-center rounded-2xl border border-slate-300 bg-white px-4 text-sm font-semibold text-slate-900 hover:bg-slate-50">
                                    Mở danh sách →
                                </a>
                            </div>
                        </div>

                        <div class="h-px bg-slate-200"></div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full text-left text-sm">
                                <thead class="bg-slate-100">
                                    <tr class="text-xs font-bold uppercase tracking-wider text-slate-600">
                                        <th class="px-6 py-4">Doanh nghiệp</th>
                                        <th class="px-6 py-4">Email</th>
                                        <th class="px-6 py-4">Ngày tạo</th>
                                        <th class="px-6 py-4">Trạng thái</th>
                                        <th class="px-6 py-4 text-right">Thao tác</th>
                                    </tr>
                                </thead>

                                <tbody class="divide-y divide-slate-200">
                                    @if (Model.PendingBusinessesPreview == null || !Model.PendingBusinessesPreview.Any())
                                    {
                                        <tr>
                                            <td colspan="5" class="px-6 py-6 text-sm text-slate-500">
                                                Không có doanh nghiệp pending.
                                            </td>
                                        </tr>
                                    }
                                    else
                                    {
                                        foreach (var b in Model.PendingBusinessesPreview)
                                        {
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-6 py-4">
                                                    <div class="font-semibold text-slate-900">@b.BusinessName</div>
                                                    <div class="text-xs text-slate-500">#BIZ-@b.Id • Risk @b.RiskLevel</div>
                                                </td>
                                                <td class="px-6 py-4">
                                                    <div class="font-semibold text-slate-900">@b.OwnerEmail</div>
                                                </td>
                                                <td class="px-6 py-4 text-slate-700">@b.CreatedAt.ToString("dd/MM HH:mm")</td>
                                                <td class="px-6 py-4">
                                                    <span class="@BizBadge(b.Status)">@BizText(b.Status)</span>
                                                </td>
                                                <td class="px-6 py-4">
                                                    <div class="flex justify-end gap-2">
                                                        <a asp-controller="AdminBusinesses" asp-action="Index" asp-route-q="@b.OwnerEmail"
                                                           class="inline-flex h-10 min-w-[92px] items-center justify-center rounded-xl border border-slate-300 bg-white px-3 text-xs font-bold text-slate-900 hover:bg-slate-50">
                                                            Xem
                                                        </a>

                                                        <form asp-controller="AdminBusinesses" asp-action="Approve" method="post">
                                                            @Html.AntiForgeryToken()
                                                            <input type="hidden" name="id" value="@b.Id" />
                                                            <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />
                                                            <button type="submit"
                                                                    class="inline-flex h-10 min-w-[92px] items-center justify-center rounded-xl bg-emerald-600 px-3 text-xs font-bold text-white hover:bg-emerald-700">
                                                                Duyệt
                                                            </button>
                                                        </form>

                                                        <form asp-controller="AdminBusinesses" asp-action="Reject" method="post">
                                                            @Html.AntiForgeryToken()
                                                            <input type="hidden" name="id" value="@b.Id" />
                                                            <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />
                                                            <button type="submit"
                                                                    class="inline-flex h-10 min-w-[92px] items-center justify-center rounded-xl bg-rose-600 px-3 text-xs font-bold text-white hover:bg-rose-700">
                                                                Từ chối
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="flex flex-col gap-3 px-6 py-5 sm:flex-row sm:items-center sm:justify-between">
                            <div class="text-sm text-slate-600">
                                Preview tối đa <span class="font-semibold text-slate-900">8</span> doanh nghiệp pending
                            </div>
                            <a asp-controller="AdminBusinesses" asp-action="Index"
                               class="inline-flex h-11 items-center justify-center rounded-2xl border border-slate-300 bg-white px-4 text-sm font-semibold text-slate-900 hover:bg-slate-50">
                                Xem tất cả doanh nghiệp →
                            </a>
                        </div>
                    </section>

                    <!-- Bên phải giữ phần users như bé đang có -->
                    <aside class="lg:col-span-5 space-y-6">

                        <section class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                            <div class="flex items-start justify-between gap-3">
                                <div>
                                    <div class="text-lg font-extrabold text-slate-900">Kiểm duyệt người dùng</div>
                                    <div class="mt-1 text-sm text-slate-600">Các tài khoản mới nhất (từ DB)</div>
                                </div>
                                <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-bold text-slate-700 ring-1 ring-slate-200">
                                    Live
                                </span>
                            </div>

                            <div class="mt-5 space-y-3">
                                @if (Model.RecentUsers == null || !Model.RecentUsers.Any())
                                {
                                    <div class="text-sm text-slate-500">Chưa có người dùng nào.</div>
                                }
                                else
                                {
                                    foreach (var u in Model.RecentUsers.Take(2))
                                    {
                                        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
                                            <div class="flex items-start justify-between gap-3">
                                                <div>
                                                    <div class="font-semibold text-slate-900">@u.FullName</div>
                                                    <div class="text-xs text-slate-500">@u.Email</div>
                                                </div>
                                                <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-bold text-slate-700 ring-1 ring-slate-200">
                                                    @u.Role
                                                </span>
                                            </div>

                                            <div class="mt-3 flex flex-wrap gap-2">
                                                <a asp-controller="AdminUsers" asp-action="Index"
                                                   class="inline-flex h-10 min-w-[120px] items-center justify-center rounded-xl border border-slate-300 bg-white px-3 text-xs font-bold text-slate-900 hover:bg-slate-50">
                                                    Xem
                                                </a>

                                                <form asp-controller="AdminUsers" asp-action="Delete" method="post">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@u.Id" />
                                                    <button type="submit"
                                                            class="inline-flex h-10 min-w-[120px] items-center justify-center rounded-xl bg-rose-600 px-3 text-xs font-bold text-white hover:bg-rose-700">
                                                        Xóa người dùng
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>

                            <div class="mt-5">
                                <a asp-controller="AdminUsers" asp-action="Index"
                                   class="inline-flex h-11 w-full items-center justify-center rounded-2xl border border-slate-300 bg-white px-4 text-sm font-semibold text-slate-900 hover:bg-slate-50">
                                    Xem tất cả người dùng →
                                </a>
                            </div>
                        </section>

                        <section class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                            <div class="text-lg font-extrabold text-slate-900">Công cụ quản trị</div>
                            <p class="mt-1 text-sm text-slate-600">Lối tắt vận hành (an toàn / có ghi log)</p>

                            <div class="mt-5 space-y-3">
                                <a asp-controller="AdminBusinesses" asp-action="Index"
                                   class="flex items-center justify-between rounded-2xl border border-slate-200 bg-white px-4 py-4 text-sm font-semibold text-slate-900 hover:bg-slate-50">
                                    <span>Duyệt doanh nghiệp chờ duyệt</span>
                                    <span class="text-slate-400">→</span>
                                </a>

                                <a asp-controller="AdminUsers" asp-action="Index"
                                   class="flex items-center justify-between rounded-2xl border border-slate-200 bg-white px-4 py-4 text-sm font-semibold text-slate-900 hover:bg-slate-50">
                                    <span>Kiểm duyệt người dùng</span>
                                    <span class="text-slate-400">→</span>
                                </a>

                                <button type="button"
                                        class="flex w-full items-center justify-between rounded-2xl border border-slate-200 bg-white px-4 py-4 text-sm font-semibold text-slate-900 hover:bg-slate-50">
                                    <span>Xuất báo cáo (sắp có)</span>
                                    <span class="text-slate-400">↗</span>
                                </button>
                            </div>

                            <div class="mt-5 rounded-2xl border border-slate-200 bg-slate-50 p-4">
                                <div class="text-sm font-bold text-slate-900">Ghi chú</div>
                                <div class="mt-1 text-sm text-slate-600">
                                    Doanh nghiệp pending không thể tạo dịch vụ/nhân viên cho đến khi được admin duyệt.
                                </div>
                            </div>
                        </section>

                    </aside>
                </div>

            </main>
        </div>
    </div>
</div>
