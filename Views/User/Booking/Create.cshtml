@model booking.ViewModels.BookingCreateVm

@{
    ViewData["Title"] = "ƒê·∫∑t l·ªãch";
    string PriceVnd(decimal v) => string.Format(System.Globalization.CultureInfo.GetCultureInfo("vi-VN"), "{0:N0}ƒë", v);
}

<div class="min-h-screen bg-slate-50">
    <div class="mx-auto max-w-6xl px-4 sm:px-6 py-6 sm:py-10">

        <!-- Breadcrumb -->
        <div class="flex items-center gap-2 text-sm text-slate-600">
            <a asp-controller="Home" asp-action="Index" class="text-indigo-600 font-semibold hover:underline">Kh√°m ph√°</a>
            <span class="text-slate-400">/</span>
            <span class="text-slate-900 font-semibold">ƒê·∫∑t l·ªãch</span>
        </div>

        <!-- STACK D·ªåC: form tr√™n, summary d∆∞·ªõi -->
        <div class="mt-6 space-y-8">

            <!-- FORM -->
            <div>
                <div class="rounded-3xl border border-slate-200 bg-white shadow-sm">
                    <div class="p-6 sm:p-7">

                        <div class="flex items-start justify-between gap-4">
                            <div>
                                <div class="text-base font-extrabold text-slate-900">Th√¥ng tin ƒë·∫∑t l·ªãch</div>
                                <div class="mt-1 text-sm text-slate-600">ƒêi·ªÅn nhanh 30 gi√¢y l√† xong.</div>
                            </div>

                            <div class="hidden sm:flex items-center gap-2 rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-600">
                                <span class="inline-flex h-2.5 w-2.5 rounded-full bg-indigo-600"></span>
                                <span>ƒêang ch·ªçn</span>
                                <span class="mx-1 text-slate-300">‚Ä¢</span>
                                <span class="inline-flex h-2.5 w-2.5 rounded-full bg-slate-900"></span>
                                <span>ƒê√£ ƒë·∫∑t</span>
                                <span class="mx-1 text-slate-300">‚Ä¢</span>
                                <span class="inline-flex h-2.5 w-2.5 rounded-full border border-slate-300 bg-white"></span>
                                <span>C√≤n tr·ªëng</span>
                            </div>
                        </div>

                        @if (!ViewData.ModelState.IsValid)
                        {
                            <div class="mt-5 rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-800">
                                Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin (c√≥ l·ªói ·ªü m·ªôt v√†i tr∆∞·ªùng).
                            </div>
                        }

                        <form asp-action="Create" method="post" class="mt-6 space-y-5">
                            @Html.AntiForgeryToken()
                            <input type="hidden" asp-for="ServiceId" />

                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                <div>
                                    <label class="text-xs font-semibold text-slate-600">H·ªç t√™n</label>
                                    <input asp-for="CustomerName"
                                           class="mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 placeholder:text-slate-400
                                                  focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
                                    <span class="mt-1 block text-xs text-rose-600">@Html.ValidationMessageFor(m => m.CustomerName)</span>
                                </div>

                                <div>
                                    <label class="text-xs font-semibold text-slate-600">S·ªë ƒëi·ªán tho·∫°i</label>
                                    <input asp-for="Phone"
                                           class="mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 placeholder:text-slate-400
                                                  focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
                                    <span class="mt-1 block text-xs text-rose-600">@Html.ValidationMessageFor(m => m.Phone)</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 gap-4 lg:grid-cols-12">
                                <div class="lg:col-span-5">
                                    <label class="text-xs font-semibold text-slate-600">Ng√†y</label>
                                    <input asp-for="Date" type="date"
                                           class="mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900
                                                  focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
                                    <span class="mt-1 block text-xs text-rose-600">@Html.ValidationMessageFor(m => m.Date)</span>
                                </div>

                                <div class="lg:col-span-7">
                                    <label class="text-xs font-semibold text-slate-600">Gi·ªù</label>

                                    <!-- field submit th·∫≠t -->
                                    <input type="hidden" asp-for="Time" id="timeValue" />

                                    <div class="mt-2 rounded-2xl border border-slate-200 bg-slate-50 p-4">
                                        <!-- GI·∫¢M C·ªòT + TƒÇNG GAP ƒë·ªÉ √¥ to v√† kh√¥ng c·∫Øt "09:00" -->
                                        <div class="grid grid-cols-3 gap-3 sm:grid-cols-4 lg:grid-cols-5">
                                            @foreach (var slot in Model.TimeSlots)
                                            {
                                                var isActive = Model.Time == slot.Value;

                                                // Modern states:
                                                // - free: white + subtle hover
                                                // - active: indigo filled + ring
                                                // - booked: muted + not-allowed + hover shows overlay
                                                var cls = slot.IsBooked
                                                    ? "bg-slate-100 border-slate-200 text-slate-400 cursor-not-allowed opacity-100"
                                                    : (isActive
                                                        ? "bg-indigo-600 border-indigo-600 text-white shadow-md ring-2 ring-indigo-200"
                                                        : "bg-white border-slate-200 text-slate-900 hover:border-indigo-300 hover:bg-indigo-50 hover:shadow-sm");

                                                <button type="button"
                                                        data-time="@slot.Value"
                                                        class="slot-btn group relative h-12 w-full rounded-2xl border px-4 text-base font-semibold tracking-wide transition @cls"
                                                        aria-disabled="@(slot.IsBooked ? "true" : "false")"
                                                        disabled="@(slot.IsBooked ? "disabled" : null)"
                                                        title="@(slot.IsBooked ? "ƒê√£ c√≥ ng∆∞·ªùi ƒë·∫∑t" : "Ch·ªçn gi·ªù")">

                                                    <span class="inline-flex items-center justify-center gap-2">
                                                        @slot.Value
                                                        @if (slot.IsBooked)
                                                        {
                                                            <span class="text-slate-400">üîí</span>
                                                        }
                                                    </span>

                                                    @* Overlay hover ƒë·ªÉ nh√¨n ph√°t bi·∫øt ‚Äúkh√¥ng ch·ªçn ƒë∆∞·ª£c‚Äù.
                                                       L∆∞u √Ω: booked v·∫´n hover ƒë∆∞·ª£c v√¨ KH√îNG d√πng pointer-events-none,
                                                       nh∆∞ng click v·∫´n b·ªã ch·∫∑n v√¨ disabled. *@
                                                    @if (slot.IsBooked)
                                                    {
                                                        <span class="pointer-events-none absolute inset-0 hidden items-center justify-center rounded-2xl bg-white/60 text-sm font-semibold text-slate-700 backdrop-blur-[1px] group-hover:flex">
                                                            üö´ ƒê√£ ƒë·∫∑t
                                                        </span>
                                                    }
                                                </button>
                                            }
                                        </div>

                                        <div class="mt-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                            <div class="text-xs text-slate-500">
                                                Ch·ªçn 1 khung gi·ªù ph√π h·ª£p. Slot ƒë√£ ƒë·∫∑t s·∫Ω b·ªã kh√≥a.
                                            </div>

                                            <div class="sm:hidden flex items-center gap-2 text-xs text-slate-600">
                                                <span class="inline-flex h-2.5 w-2.5 rounded-full bg-indigo-600"></span><span>Ch·ªçn</span>
                                                <span class="mx-1 text-slate-300">‚Ä¢</span>
                                                <span class="inline-flex h-2.5 w-2.5 rounded-full bg-slate-900"></span><span>ƒê·∫∑t</span>
                                                <span class="mx-1 text-slate-300">‚Ä¢</span>
                                                <span class="inline-flex h-2.5 w-2.5 rounded-full border border-slate-300 bg-white"></span><span>Tr·ªëng</span>
                                            </div>
                                        </div>

                                        <span class="mt-2 block text-xs text-rose-600">
                                            @Html.ValidationMessageFor(m => m.Time)
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="text-xs font-semibold text-slate-600">Ghi ch√∫ (tu·ª≥ ch·ªçn)</label>
                                <textarea asp-for="Note" rows="3"
                                          class="mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 placeholder:text-slate-400
                                                 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                          placeholder="V√≠ d·ª•: m√¨nh ƒë·∫øn tr·ªÖ 10 ph√∫t, c·∫ßn d·ªãch v·ª• th√™m..."></textarea>
                                <span class="mt-1 block text-xs text-rose-600">@Html.ValidationMessageFor(m => m.Note)</span>
                            </div>

                            <button type="submit"
                                    class="inline-flex w-full items-center justify-center rounded-2xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white
                                           hover:bg-indigo-700 transition shadow-sm">
                                X√°c nh·∫≠n ƒë·∫∑t l·ªãch ‚Üí
                            </button>

                            <a asp-controller="Services" asp-action="Details" asp-route-id="@Model.ServiceId"
                               class="inline-flex w-full items-center justify-center rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-700
                                      hover:bg-slate-50 transition">
                                Quay l·∫°i chi ti·∫øt
                            </a>
                        </form>
                    </div>
                </div>
            </div>

            <!-- SUMMARY ƒê∆ØA XU·ªêNG D∆Ø·ªöI + FULL WIDTH -->
            <div>
                <div class="rounded-3xl border border-slate-200 bg-white shadow-md overflow-hidden">
                    <div class="p-6 sm:p-7">
                        <div class="text-sm font-semibold text-slate-900">T√≥m t·∫Øt d·ªãch v·ª•</div>

                        <div class="mt-4">
                            <div class="text-2xl font-extrabold text-slate-900 leading-tight">@Model.ServiceName</div>

                            <div class="mt-3 space-y-2 text-sm text-slate-700">
                                @if (!string.IsNullOrWhiteSpace(Model.Location))
                                {
                                    <div class="flex items-center gap-2">
                                        <span class="inline-flex h-8 w-8 items-center justify-center rounded-2xl bg-slate-100 text-slate-700">üìç</span>
                                        <span>@Model.Location</span>
                                    </div>
                                }
                                <div class="flex items-center gap-2">
                                    <span class="inline-flex h-8 w-8 items-center justify-center rounded-2xl bg-slate-100 text-slate-700">‚è±</span>
                                    <span>@Model.DurationMinutes ph√∫t</span>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 rounded-3xl border border-indigo-200 bg-indigo-50 p-6">
                            <div class="text-xs font-semibold text-indigo-700">Gi√° t·ª´</div>
                            <div class="mt-1 text-4xl font-extrabold text-slate-900">@PriceVnd(Model.Price)</div>
                            <div class="mt-2 text-xs text-slate-600">Demo: ch∆∞a t√≠nh ph·ª• ph√≠</div>
                        </div>
                    </div>

                    <div class="border-t border-slate-200 bg-white px-6 py-4">
                        <div class="text-xs text-slate-500">
                            M·∫πo: n·∫øu slot v·ª´a b·ªã ng∆∞·ªùi kh√°c ƒë·∫∑t, h·ªá th·ªëng s·∫Ω b√°o v√† y√™u c·∫ßu ch·ªçn l·∫°i.
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="py-10 text-center text-xs text-slate-500">
            ¬© @DateTime.Now.Year Booking
        </div>
    </div>
</div>

@section Scripts {
    @if (TempData["SwalError"] != null)
    {
        <script>
          Swal.fire({
            icon: 'error',
            title: 'Kh√¥ng ƒë·∫∑t ƒë∆∞·ª£c',
            text: @Html.Raw(Json.Serialize(TempData["SwalError"])),
            confirmButtonText: 'OK'
          });
        </script>
    }

    @if (TempData["SwalSuccess"] != null)
    {
        <script>
          Swal.fire({
            icon: 'success',
            title: 'Th√†nh c√¥ng',
            text: @Html.Raw(Json.Serialize(TempData["SwalSuccess"])),
            confirmButtonText: 'OK'
          });
        </script>
    }

    <script>
      (function () {
        const input = document.getElementById('timeValue');
        if (!input) return;

        const buttons = document.querySelectorAll('.slot-btn');

        // ƒê·∫£m b·∫£o kh√¥ng b·ªã d√≠nh "text-white" ·ªü slot tr·ªëng khi hover:
        // reset theo 2 b·ªô class c·ªë ƒë·ªãnh FREE/ACTIVE, b·ªè ki·ªÉu add/remove l·∫ª t·∫ª.

        const FREE = [
          'bg-white','border-slate-200','text-slate-900',
          'hover:border-indigo-300','hover:bg-indigo-50','hover:shadow-sm'
        ];

        const ACTIVE = [
          'bg-indigo-600','border-indigo-600','text-white',
          'shadow-md','ring-2','ring-indigo-200'
        ];

        function isDisabled(btn) {
          return btn.disabled || btn.getAttribute('aria-disabled') === 'true';
        }

        function applyClasses(el, addList, removeList) {
          removeList.forEach(c => el.classList.remove(c));
          addList.forEach(c => el.classList.add(c));
        }

        function resetFree() {
          buttons.forEach(b => {
            if (isDisabled(b)) return; // booked
            applyClasses(b, FREE, ACTIVE);
          });
        }

        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            if (isDisabled(btn)) return;

            const t = btn.getAttribute('data-time');
            if (!t) return;

            input.value = t;

            // reset t·∫•t c·∫£ slot tr·ªëng v·ªÅ FREE
            resetFree();

            // set slot ƒëang ch·ªçn v·ªÅ ACTIVE
            applyClasses(btn, ACTIVE, FREE);
          });
        });
      })();
    </script>
}
