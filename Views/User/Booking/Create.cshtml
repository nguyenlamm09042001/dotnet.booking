@model booking.ViewModels.BookingCreateVm

@{
    ViewData["Title"] = "ƒê·∫∑t l·ªãch";
    string PriceVnd(decimal v) => string.Format(System.Globalization.CultureInfo.GetCultureInfo("vi-VN"), "{0:N0}ƒë", v);
}

<div class="min-h-screen bg-slate-50">
    <div class="mx-auto max-w-6xl px-4 sm:px-6 py-6 sm:py-10">

        <!-- Breadcrumb -->
        <div class="flex items-center gap-2 text-sm text-slate-600">
            <a asp-controller="Home" asp-action="Index" class="text-indigo-600 font-semibold hover:underline">Kh√°m ph√°</a>
            <span class="text-slate-400">/</span>
            <span class="text-slate-900 font-semibold">ƒê·∫∑t l·ªãch</span>
        </div>

        <!-- STACK D·ªåC: form tr√™n, summary d∆∞·ªõi -->
        <div class="mt-6 space-y-8">

            <!-- FORM -->
            <div>
                <div class="rounded-3xl border border-slate-200 bg-white shadow-sm">
                    <div class="p-6 sm:p-7">

                        <div class="flex items-start justify-between gap-4">
                            <div>
                                <div class="text-base font-extrabold text-slate-900">Th√¥ng tin ƒë·∫∑t l·ªãch</div>
                                <div class="mt-1 text-sm text-slate-600">ƒêi·ªÅn nhanh 30 gi√¢y l√† xong.</div>
                            </div>

                            <div class="hidden sm:flex items-center gap-2 rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-600">
                                <span class="inline-flex h-2.5 w-2.5 rounded-full bg-indigo-600"></span>
                                <span>ƒêang ch·ªçn</span>
                                <span class="mx-1 text-slate-300">‚Ä¢</span>
                                <span class="inline-flex h-2.5 w-2.5 rounded-full bg-slate-900"></span>
                                <span>ƒê√£ ƒë·∫∑t</span>
                                <span class="mx-1 text-slate-300">‚Ä¢</span>
                                <span class="inline-flex h-2.5 w-2.5 rounded-full border border-slate-300 bg-white"></span>
                                <span>C√≤n tr·ªëng</span>
                            </div>
                        </div>

                        @if (!ViewData.ModelState.IsValid)
                        {
                            <div class="mt-5 rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-800">
                                Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin (c√≥ l·ªói ·ªü m·ªôt v√†i tr∆∞·ªùng).
                            </div>
                        }

                        <form asp-action="Create" method="post" class="mt-6 space-y-5">
                            @Html.AntiForgeryToken()
                            <input type="hidden" asp-for="ServiceId" />

                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                <div>
                                    <label class="text-xs font-semibold text-slate-600">H·ªç t√™n</label>
                                    <input asp-for="CustomerName"
                                           class="mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 placeholder:text-slate-400
                                                  focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
                                    <span class="mt-1 block text-xs text-rose-600">@Html.ValidationMessageFor(m => m.CustomerName)</span>
                                </div>

                                <div>
                                    <label class="text-xs font-semibold text-slate-600">S·ªë ƒëi·ªán tho·∫°i</label>
                                    <input asp-for="Phone"
                                           class="mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 placeholder:text-slate-400
                                                  focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
                                    <span class="mt-1 block text-xs text-rose-600">@Html.ValidationMessageFor(m => m.Phone)</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 gap-4 lg:grid-cols-12">
                                <div class="lg:col-span-5">
                                    <label class="text-xs font-semibold text-slate-600">Ng√†y</label>
<input asp-for="Date"
       type="date"
       id="dateInput"
       min="@DateTime.Today.ToString("yyyy-MM-dd")"
       class="mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900
              focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />

                                    <span class="mt-1 block text-xs text-rose-600">@Html.ValidationMessageFor(m => m.Date)</span>
                                </div>

                                <div class="lg:col-span-7">
                                    <label class="text-xs font-semibold text-slate-600">Gi·ªù</label>

                                    <!-- field submit th·∫≠t -->
                                    <input type="hidden" asp-for="Time" id="timeValue" />

                                    <div class="mt-2 rounded-2xl border border-slate-200 bg-slate-50 p-4">
                                        <!-- GI·∫¢M C·ªòT + TƒÇNG GAP ƒë·ªÉ √¥ to v√† kh√¥ng c·∫Øt "09:00" -->
<div id="slotsGrid" class="grid grid-cols-3 gap-3 sm:grid-cols-4 lg:grid-cols-5"></div>


                                        <div class="mt-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                            <div class="text-xs text-slate-500">
                                                Ch·ªçn 1 khung gi·ªù ph√π h·ª£p. Slot ƒë√£ ƒë·∫∑t s·∫Ω b·ªã kh√≥a.
                                            </div>

                                            <div class="sm:hidden flex items-center gap-2 text-xs text-slate-600">
                                                <span class="inline-flex h-2.5 w-2.5 rounded-full bg-indigo-600"></span><span>Ch·ªçn</span>
                                                <span class="mx-1 text-slate-300">‚Ä¢</span>
                                                <span class="inline-flex h-2.5 w-2.5 rounded-full bg-slate-900"></span><span>ƒê·∫∑t</span>
                                                <span class="mx-1 text-slate-300">‚Ä¢</span>
                                                <span class="inline-flex h-2.5 w-2.5 rounded-full border border-slate-300 bg-white"></span><span>Tr·ªëng</span>
                                            </div>
                                        </div>

                                        <span class="mt-2 block text-xs text-rose-600">
                                            @Html.ValidationMessageFor(m => m.Time)
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="text-xs font-semibold text-slate-600">Ghi ch√∫ (tu·ª≥ ch·ªçn)</label>
                                <textarea asp-for="Note" rows="3"
                                          class="mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 placeholder:text-slate-400
                                                 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                          placeholder="V√≠ d·ª•: m√¨nh ƒë·∫øn tr·ªÖ 10 ph√∫t, c·∫ßn d·ªãch v·ª• th√™m..."></textarea>
                                <span class="mt-1 block text-xs text-rose-600">@Html.ValidationMessageFor(m => m.Note)</span>
                            </div>

                            <button type="submit"
                                    class="inline-flex w-full items-center justify-center rounded-2xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white
                                           hover:bg-indigo-700 transition shadow-sm">
                                X√°c nh·∫≠n ƒë·∫∑t l·ªãch ‚Üí
                            </button>

                            <a asp-controller="Services" asp-action="Details" asp-route-id="@Model.ServiceId"
                               class="inline-flex w-full items-center justify-center rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-700
                                      hover:bg-slate-50 transition">
                                Quay l·∫°i chi ti·∫øt
                            </a>
                        </form>
                    </div>
                </div>
            </div>

            <!-- SUMMARY ƒê∆ØA XU·ªêNG D∆Ø·ªöI + FULL WIDTH -->
            <div>
                <div class="rounded-3xl border border-slate-200 bg-white shadow-md overflow-hidden">
                    <div class="p-6 sm:p-7">
                        <div class="text-sm font-semibold text-slate-900">T√≥m t·∫Øt d·ªãch v·ª•</div>

                        <div class="mt-4">
                            <div class="text-2xl font-extrabold text-slate-900 leading-tight">@Model.ServiceName</div>

                            <div class="mt-3 space-y-2 text-sm text-slate-700">
                                @if (!string.IsNullOrWhiteSpace(Model.Location))
                                {
                                    <div class="flex items-center gap-2">
                                        <span class="inline-flex h-8 w-8 items-center justify-center rounded-2xl bg-slate-100 text-slate-700">üìç</span>
                                        <span>@Model.Location</span>
                                    </div>
                                }
                                <div class="flex items-center gap-2">
                                    <span class="inline-flex h-8 w-8 items-center justify-center rounded-2xl bg-slate-100 text-slate-700">‚è±</span>
                                    <span>@Model.DurationMinutes ph√∫t</span>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 rounded-3xl border border-indigo-200 bg-indigo-50 p-6">
                            <div class="text-xs font-semibold text-indigo-700">Gi√° t·ª´</div>
                            <div class="mt-1 text-4xl font-extrabold text-slate-900">@PriceVnd(Model.Price)</div>
                            <div class="mt-2 text-xs text-slate-600">Demo: ch∆∞a t√≠nh ph·ª• ph√≠</div>
                        </div>
                    </div>

                    <div class="border-t border-slate-200 bg-white px-6 py-4">
                        <div class="text-xs text-slate-500">
                            M·∫πo: n·∫øu slot v·ª´a b·ªã ng∆∞·ªùi kh√°c ƒë·∫∑t, h·ªá th·ªëng s·∫Ω b√°o v√† y√™u c·∫ßu ch·ªçn l·∫°i.
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="py-10 text-center text-xs text-slate-500">
            ¬© @DateTime.Now.Year Booking
        </div>
    </div>
</div>

@section Scripts {
    @if (TempData["SwalError"] != null)
    {
        <script>
          Swal.fire({
            icon: 'error',
            title: 'Kh√¥ng ƒë·∫∑t ƒë∆∞·ª£c',
            text: @Html.Raw(Json.Serialize(TempData["SwalError"])),
            confirmButtonText: 'OK'
          });
        </script>
    }

    @if (TempData["SwalSuccess"] != null)
    {
        <script>
          Swal.fire({
            icon: 'success',
            title: 'Th√†nh c√¥ng',
            text: @Html.Raw(Json.Serialize(TempData["SwalSuccess"])),
            confirmButtonText: 'OK'
          });
        </script>
    }

  <script>
(function () {
  const serviceId = document.querySelector('input[name="ServiceId"]')?.value;
  const dateInput = document.getElementById('dateInput');
  const grid = document.getElementById('slotsGrid');
  const timeValue = document.getElementById('timeValue');

  if (!serviceId || !dateInput || !grid || !timeValue) return;

  const FREE = [
    'bg-white','border-slate-200','text-slate-900',
    'hover:border-indigo-300','hover:bg-indigo-50','hover:shadow-sm'
  ];
  const ACTIVE = [
    'bg-indigo-600','border-indigo-600','text-white',
    'shadow-md','ring-2','ring-indigo-200'
  ];
  const BOOKED = [
    'bg-slate-100','border-slate-200','text-slate-400','cursor-not-allowed','opacity-100'
  ];

  function apply(el, add, remove) {
    remove.forEach(c => el.classList.remove(c));
    add.forEach(c => el.classList.add(c));
  }

  function slotButton(slot, selected) {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'slot-btn group relative h-12 w-full rounded-2xl border px-4 text-base font-semibold tracking-wide transition';
    btn.dataset.time = slot.value;

    if (slot.isBooked) {
      btn.disabled = true;
      btn.setAttribute('aria-disabled', 'true');
      apply(btn, BOOKED, [...FREE, ...ACTIVE]);
btn.title = slot.isPast ? 'Gi·ªù n√†y ƒë√£ qua' : 'ƒê√£ c√≥ ng∆∞·ªùi ƒë·∫∑t';
      btn.innerHTML = `
        <span class="inline-flex items-center justify-center gap-2">
          ${slot.value} <span class="text-slate-400">üîí</span>
        </span>
       <span class="pointer-events-none absolute inset-0 hidden items-center justify-center rounded-2xl bg-white/60 text-sm font-semibold text-slate-700 backdrop-blur-[1px] group-hover:flex">
  ${slot.isPast ? '‚è± ƒê√£ qua gi·ªù' : 'üö´ ƒê√£ ƒë·∫∑t'}
</span>`;

      return btn;
    }

    btn.setAttribute('aria-disabled', 'false');
    btn.title = 'Ch·ªçn gi·ªù';

    if (selected) apply(btn, ACTIVE, FREE);
    else apply(btn, FREE, ACTIVE);

    btn.innerHTML = `<span class="inline-flex items-center justify-center gap-2">${slot.value}</span>`;

    btn.addEventListener('click', () => {
      timeValue.value = slot.value;

      // reset free
      grid.querySelectorAll('.slot-btn').forEach(b => {
        if (b.disabled || b.getAttribute('aria-disabled') === 'true') return;
        apply(b, FREE, ACTIVE);
      });

      // active
      apply(btn, ACTIVE, FREE);
    });

    return btn;
  }

  async function loadSlots() {
    const date = dateInput.value;
    if (!date) {
      grid.innerHTML = '';
      timeValue.value = '';
      return;
    }

    const todayStr = new Date().toISOString().slice(0, 10); // yyyy-mm-dd

// ‚úÖ N·∫øu ng√†y < h√¥m nay => UI kho√° lu√¥n, kh√¥ng fetch n·ªØa
if (date < todayStr) {
  grid.innerHTML = `
    <div class="col-span-full rounded-2xl border border-rose-200 bg-rose-50 p-4 text-sm text-rose-700">
      ‚õî Ng√†y b·∫°n ch·ªçn ƒë√£ qua. Vui l√≤ng ch·ªçn ng√†y kh√°c.
    </div>`;
  timeValue.value = '';
  return;
}


    // ƒë·ªïi ng√†y => reset gi·ªù ƒë√£ ch·ªçn
    timeValue.value = '';

    grid.innerHTML = `
      <div class="col-span-full rounded-2xl border border-slate-200 bg-white p-4 text-sm text-slate-600">
        ƒêang t·∫£i khung gi·ªù tr·ªëng...
      </div>`;

    try {
      const res = await fetch(`/Booking/AvailableSlots?serviceId=${encodeURIComponent(serviceId)}&date=${encodeURIComponent(date)}`, {
        headers: { 'Accept': 'application/json' }
      });

      if (!res.ok) throw new Error('Fetch failed');

      const slots = await res.json();

      // ===== disable slot ƒë√£ qua n·∫øu ch·ªçn H√îM NAY =====
const todayStr = new Date().toISOString().slice(0, 10); // yyyy-mm-dd
if (dateInput.value === todayStr) {
  const now = new Date();
  const nowMin = now.getHours() * 60 + now.getMinutes();

  slots.forEach(s => {
    const [hh, mm] = (s.value || "00:00").split(':').map(Number);
    const slotMin = hh * 60 + mm;

    // 18:26 -> 18:00 b·ªã kho√°, 18:30 c√≤n ch·ªçn ƒë∆∞·ª£c
    if (slotMin < nowMin) {
      s.isBooked = true;
      s.isPast = true;
    }
  });
}


      grid.innerHTML = '';
      if (!slots || slots.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full rounded-2xl border border-slate-200 bg-white p-4 text-sm text-slate-600">
            D·ªãch v·ª• ƒëang t·∫°m ƒë√≥ng ho·∫∑c kh√¥ng c√≥ khung gi·ªù cho ng√†y n√†y.
          </div>`;
        return;
      }

      // auto select first free slot
      const firstFree = slots.find(x => !x.isBooked)?.value || '';
      if (firstFree) timeValue.value = firstFree;

      slots.forEach(s => {
        const el = slotButton(s, s.value === firstFree);
        grid.appendChild(el);
      });

    } catch (e) {
      grid.innerHTML = `
        <div class="col-span-full rounded-2xl border border-rose-200 bg-rose-50 p-4 text-sm text-rose-700">
          Kh√¥ng t·∫£i ƒë∆∞·ª£c khung gi·ªù. Th·ª≠ l·∫°i ho·∫∑c reload trang.
        </div>`;
    }
  }

  // load l·∫ßn ƒë·∫ßu (khi page m·ªü)
  loadSlots();

  // ƒë·ªïi ng√†y -> load l·∫°i
  dateInput.addEventListener('change', loadSlots);
})();
</script>

}
