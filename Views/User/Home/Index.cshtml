@model IEnumerable<booking.Models.Service>

@{
    ViewData["Title"] = "Khám phá";

    string PriceVnd(decimal v) =>
        string.Format(System.Globalization.CultureInfo.GetCultureInfo("vi-VN"), "{0:N0}đ", v);

    var q = (string)(ViewBag.Q ?? "");
    var loc = (string)(ViewBag.Location ?? "");
    var cat = (string)(ViewBag.Category ?? "");
    var sort = (string)(ViewBag.Sort ?? "");

    var cats = ViewBag.CategoryChips as List<booking.Controllers.UserController.CategoryChipVm>
               ?? new List<booking.Controllers.UserController.CategoryChipVm>();

    var services = Model?.ToList() ?? new List<booking.Models.Service>();
    var totalShowing = services.Count;

    // ✅ placeholder ảnh service (bé nhớ tạo file này trong wwwroot/images/)
    var servicePlaceholder = Url.Content("~/images/placeholder-service.png");
}

<div class="min-h-screen bg-slate-50">
    <!-- Thanh trên -->
    <div class="sticky top-0 z-30 border-b border-slate-200 bg-white/80 backdrop-blur">
        <div class="mx-auto max-w-6xl px-4 sm:px-6 py-4">
            <div class="flex items-center justify-between gap-4">
                <div class="min-w-0">
                    <div class="text-xs text-slate-500">Booking</div>
                    <div class="truncate text-lg sm:text-xl font-semibold text-slate-900">
                        Khám phá dịch vụ
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    @if (User?.Identity?.IsAuthenticated ?? false)
                    {
                        <div class="flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-3 py-2">
                            <span class="text-xs text-slate-500">Xin chào,</span>
                            <span class="text-sm font-semibold text-slate-900">
                                @(User.Identity?.Name ?? "User")
                            </span>
                        </div>

                        <a asp-controller="Booking" asp-action="Index"
                           class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold text-slate-800 hover:bg-slate-50">
                            Lịch của tôi
                        </a>

                        <a asp-controller="Notifications" asp-action="Index"
                           class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50">
                            🔔 Thông báo
                        </a>

                        <form asp-controller="Account" asp-action="Logout" method="post" class="inline-block">
                            @Html.AntiForgeryToken()
                            <button type="submit"
                                    class="inline-flex items-center justify-center rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">
                                Đăng xuất
                            </button>
                        </form>
                    }
                    else
                    {
                        <a asp-controller="Account" asp-action="Login"
                           class="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-700">
                            Đăng nhập
                        </a>
                    }
                </div>
            </div>

            <!-- Tìm kiếm (GET) -->
            <form method="get" class="mt-4 grid grid-cols-1 gap-3 sm:grid-cols-12">
                <div class="sm:col-span-7">
                    <div class="relative">
                        <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">🔎</span>
                        <input name="q" value="@q" type="text"
                               placeholder="Tìm dịch vụ, địa điểm, từ khóa..."
                               class="w-full rounded-2xl border border-slate-200 bg-white pl-10 pr-3 py-3 text-sm text-slate-900
                                      placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
                    </div>
                </div>

                <div class="sm:col-span-3">
                    <div class="relative">
                        <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">📍</span>
                        <input name="location" value="@loc" type="text"
                               placeholder="Khu vực (tuỳ chọn)"
                               class="w-full rounded-2xl border border-slate-200 bg-white pl-10 pr-3 py-3 text-sm text-slate-900
                                      placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
                    </div>
                </div>

                <div class="sm:col-span-2">
                    <button type="submit"
                            class="w-full rounded-2xl bg-indigo-600 px-4 py-3 text-sm font-semibold text-white hover:bg-indigo-700 shadow-sm">
                        Tìm kiếm
                    </button>
                </div>

                <input type="hidden" name="category" value="@cat" />
                <input type="hidden" name="sort" value="@sort" />
            </form>

            <!-- Quick sort -->
            <div class="mt-3 flex flex-wrap items-center gap-2 text-xs">
                <span class="text-slate-500">Sắp xếp:</span>

                <a asp-controller="User" asp-action="Index"
                   asp-route-q="@q" asp-route-location="@loc" asp-route-category="@cat" asp-route-sort="rating"
                   class="rounded-full border border-slate-200 bg-white px-3 py-1 font-semibold text-slate-700 hover:bg-slate-50 @(sort=="rating" || string.IsNullOrWhiteSpace(sort) ? "ring-2 ring-indigo-500 border-indigo-200" : "")">
                    Rating
                </a>

                <a asp-controller="User" asp-action="Index"
                   asp-route-q="@q" asp-route-location="@loc" asp-route-category="@cat" asp-route-sort="price_asc"
                   class="rounded-full border border-slate-200 bg-white px-3 py-1 font-semibold text-slate-700 hover:bg-slate-50 @(sort=="price_asc" ? "ring-2 ring-indigo-500 border-indigo-200" : "")">
                    Giá ↑
                </a>

                <a asp-controller="User" asp-action="Index"
                   asp-route-q="@q" asp-route-location="@loc" asp-route-category="@cat" asp-route-sort="price_desc"
                   class="rounded-full border border-slate-200 bg-white px-3 py-1 font-semibold text-slate-700 hover:bg-slate-50 @(sort=="price_desc" ? "ring-2 ring-indigo-500 border-indigo-200" : "")">
                    Giá ↓
                </a>

                <a asp-controller="User" asp-action="Index"
                   asp-route-q="@q" asp-route-location="@loc" asp-route-category="@cat" asp-route-sort="new"
                   class="rounded-full border border-slate-200 bg-white px-3 py-1 font-semibold text-slate-700 hover:bg-slate-50 @(sort=="new" ? "ring-2 ring-indigo-500 border-indigo-200" : "")">
                    Mới
                </a>

                @if (!string.IsNullOrWhiteSpace(q) || !string.IsNullOrWhiteSpace(loc) || !string.IsNullOrWhiteSpace(cat) || !string.IsNullOrWhiteSpace(sort))
                {
                    <a asp-controller="User" asp-action="Index"
                       class="ml-auto rounded-full border border-slate-200 bg-white px-3 py-1 font-semibold text-slate-700 hover:bg-slate-50">
                        Xoá lọc
                    </a>
                }
            </div>
        </div>
    </div>

    <div class="mx-auto max-w-6xl px-4 sm:px-6 py-6">
        <!-- Banner -->
        <div class="rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden">
            <div class="p-6 sm:p-8">
                <div class="flex flex-col gap-5 sm:flex-row sm:items-end sm:justify-between">
                    <div>
                        <div class="inline-flex items-center gap-2 rounded-full bg-indigo-50 px-3 py-1 text-xs font-semibold text-indigo-700">
                            ✨ Trải nghiệm mới
                        </div>
                        <h1 class="mt-3 text-2xl sm:text-3xl font-bold text-slate-900">
                            Đặt dịch vụ nhanh — kiểu nền tảng marketplace
                        </h1>
                        <p class="mt-2 text-sm sm:text-base text-slate-600 max-w-2xl">
                            Khám phá dịch vụ nổi bật, so sánh lựa chọn, chọn khung giờ trống và xác nhận trong vài giây.
                        </p>
                    </div>

                    <div class="flex gap-2">
                        <a href="#pho-bien"
                           class="inline-flex items-center justify-center rounded-2xl bg-slate-900 px-4 py-2.5 text-sm font-semibold text-white hover:bg-slate-800">
                            Xem phổ biến
                        </a>
                        <button type="button"
                                class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold text-slate-800 hover:bg-slate-50"
                                onclick="window.showSwal?.('info','Demo','Trang này đã nối DB Services. Sau này nối thêm slot trống/booking.')">
                            Thông tin
                        </button>
                    </div>
                </div>

                <div class="mt-6 grid grid-cols-2 gap-3 sm:grid-cols-4">
                    <div class="rounded-2xl border border-slate-200 p-4">
                        <div class="text-xs text-slate-500">Số dịch vụ</div>
                        <div class="mt-1 text-xl font-bold text-slate-900">@totalShowing</div>
                    </div>
                    <div class="rounded-2xl border border-slate-200 p-4">
                        <div class="text-xs text-slate-500">Nhà cung cấp</div>
                        <div class="mt-1 text-xl font-bold text-slate-900">—</div>
                    </div>
                    <div class="rounded-2xl border border-slate-200 p-4">
                        <div class="text-xs text-slate-500">Đánh giá TB</div>
                        <div class="mt-1 text-xl font-bold text-slate-900">—</div>
                    </div>
                    <div class="rounded-2xl border border-slate-200 p-4">
                        <div class="text-xs text-slate-500">Xác nhận nhanh</div>
                        <div class="mt-1 text-xl font-bold text-emerald-700">Có</div>
                    </div>
                </div>
            </div>

            <div class="border-t border-slate-200 bg-slate-50 p-4 sm:p-5">
                <div class="flex flex-wrap items-center gap-2 text-xs text-slate-600">
                    <span class="font-semibold text-slate-900">Đang hot:</span>

                    <a asp-controller="User" asp-action="Index" asp-route-q="Cắt tóc"
                       class="rounded-full border border-slate-200 bg-white px-3 py-1 hover:bg-slate-50">
                        Cắt tóc
                    </a>
                    <a asp-controller="User" asp-action="Index" asp-route-q="Rửa xe"
                       class="rounded-full border border-slate-200 bg-white px-3 py-1 hover:bg-slate-50">
                        Rửa xe
                    </a>
                    <a asp-controller="User" asp-action="Index" asp-route-q="Khách sạn"
                       class="rounded-full border border-slate-200 bg-white px-3 py-1 hover:bg-slate-50">
                        Khách sạn
                    </a>
                    <a asp-controller="User" asp-action="Index" asp-route-q="Massage"
                       class="rounded-full border border-slate-200 bg-white px-3 py-1 hover:bg-slate-50">
                        Massage
                    </a>
                    <a asp-controller="User" asp-action="Index" asp-route-q="Thú cưng"
                       class="rounded-full border border-slate-200 bg-white px-3 py-1 hover:bg-slate-50">
                        Chăm thú cưng
                    </a>
                </div>
            </div>
        </div>

        <!-- Danh mục -->
        <div class="mt-6">
            <div class="flex items-end justify-between gap-3">
                <div>
                    <h2 class="text-base sm:text-lg font-semibold text-slate-900">Danh mục</h2>
                    <p class="mt-1 text-sm text-slate-600">
                        Chọn danh mục để lọc ra các dịch vụ (theo doanh nghiệp thuộc danh mục đó)
                    </p>
                </div>

                @if (!string.IsNullOrWhiteSpace(cat))
                {
                    <a asp-controller="User" asp-action="Index"
                       asp-route-q="@q" asp-route-location="@loc" asp-route-sort="@sort"
                       class="text-sm font-medium text-slate-700 hover:underline">
                        Bỏ chọn danh mục
                    </a>
                }
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
                <a asp-controller="User" asp-action="Index"
                   asp-route-q="@q" asp-route-location="@loc" asp-route-sort="@sort"
                   class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-800 hover:bg-slate-50 @(string.IsNullOrWhiteSpace(cat) ? "ring-2 ring-indigo-500 border-indigo-200" : "")">
                    Tất cả
                    <span class="rounded-full bg-slate-100 px-2 py-0.5 text-xs font-bold text-slate-700">@totalShowing</span>
                </a>

                @foreach (var c in cats)
                {
                    var name = c.Name ?? "";
                    var cnt = c.Count;

                    <a asp-controller="User" asp-action="Index"
                       asp-route-category="@name"
                       asp-route-q="@q" asp-route-location="@loc" asp-route-sort="@sort"
                       class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-800 hover:bg-slate-50 @(cat == name ? "ring-2 ring-indigo-500 border-indigo-200" : "")">
                        <span class="truncate max-w-[180px]">@name</span>
                        <span class="rounded-full bg-slate-100 px-2 py-0.5 text-xs font-bold text-slate-700">@cnt</span>
                    </a>
                }
            </div>

            @if (!cats.Any())
            {
                <div class="mt-4 rounded-3xl border border-slate-200 bg-white p-5 text-sm text-slate-600">
                    Chưa có danh mục nào trong DB BusinessCategories.
                </div>
            }
        </div>

        <!-- ✅ Dịch vụ phổ biến (DB) -->
        <div id="pho-bien" class="mt-8">
            <div class="flex items-end justify-between gap-3">
                <div>
                    <h2 class="text-base sm:text-lg font-semibold text-slate-900">Dịch vụ phổ biến</h2>
                    <p class="mt-1 text-sm text-slate-600">
                        Hiển thị từ DB (Services)
                        @if (!string.IsNullOrWhiteSpace(cat))
                        {
                            <span>• đang lọc danh mục: <span class="font-semibold text-slate-900">@cat</span></span>
                        }
                    </p>
                </div>

                <div class="flex items-center gap-2">
                    <a asp-controller="User" asp-action="Index"
                       asp-route-q="@q" asp-route-location="@loc" asp-route-category="@cat" asp-route-sort="rating"
                       class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-800 hover:bg-slate-50">
                        Lọc (rating)
                    </a>
                    <a asp-controller="User" asp-action="Index"
                       asp-route-q="@q" asp-route-location="@loc" asp-route-category="@cat" asp-route-sort="price_asc"
                       class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-800 hover:bg-slate-50">
                        Sắp xếp (giá ↑)
                    </a>
                </div>
            </div>

            <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                @foreach (var s in services)
                {
                    var thumb = string.IsNullOrWhiteSpace(s.Thumbnail) ? servicePlaceholder : Url.Content(s.Thumbnail);

                    <div class="rounded-3xl border border-slate-200 bg-white shadow-sm hover:shadow-md transition overflow-hidden">
                        <!-- ✅ THUMBNAIL -->
                        <div class="relative aspect-[16/10] bg-slate-100">
                            <img src="@thumb"
                                 class="h-full w-full object-cover"
                                 loading="lazy"
                                 onerror="this.onerror=null;this.src='@servicePlaceholder';" />

                            <!-- badge trạng thái overlay -->
                            <div class="absolute left-4 top-4">
                                @if (s.IsActive)
                                {
                                    <span class="rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-semibold text-emerald-700 ring-1 ring-emerald-100">
                                        Đang mở đặt
                                    </span>
                                }
                                else
                                {
                                    <span class="rounded-full bg-slate-100 px-2.5 py-1 text-xs font-semibold text-slate-600 ring-1 ring-slate-200">
                                        Tạm đóng
                                    </span>
                                }
                            </div>
                        </div>

                        <div class="p-5">
                            <div class="flex items-start justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="truncate text-base font-semibold text-slate-900">@s.Name</div>

@if (s.BusinessUser != null)
{
    <div class="mt-0.5 text-xs text-slate-500 truncate">
        @s.BusinessUser.FullName
    </div>
}

                                    <div class="mt-1 flex flex-wrap items-center gap-2 text-xs text-slate-500">
                                        <span>• @s.DurationMinutes phút</span>
                                        @if (!string.IsNullOrWhiteSpace(s.Location))
                                        {
                                            <span>• @s.Location</span>
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 flex items-center justify-between">
                                <div>
                                    <div class="text-lg font-bold text-slate-900">@PriceVnd(s.Price)</div>
                                    <div class="mt-1 text-xs text-slate-500">Giá từ</div>
                                </div>

                                <div class="text-right">
                                    <div class="text-sm font-semibold text-slate-900">⭐ @s.Rating.ToString("0.0")</div>
                                    <div class="mt-1 text-xs text-slate-500">@s.ReviewCount đánh giá</div>
                                </div>
                            </div>

                            <div class="mt-5 flex gap-2">
                                <a asp-controller="Booking" asp-action="Create" asp-route-serviceId="@s.Id"
                                   class="flex-1 inline-flex items-center justify-center rounded-2xl bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-indigo-700 shadow-sm @(s.IsActive ? "" : "pointer-events-none opacity-60")">
                                    Đặt ngay
                                </a>

                                <a asp-controller="Services" asp-action="Details" asp-route-id="@s.Id"
                                   class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white px-3 py-2.5 text-sm font-semibold text-slate-800 hover:bg-slate-50">
                                    Chi tiết
                                </a>
                            </div>
                        </div>
                    </div>
                }
            </div>

            @if (!services.Any())
            {
                <div class="mt-6 rounded-3xl border border-slate-200 bg-white p-6 text-sm text-slate-600">
                    Không tìm thấy dịch vụ phù hợp. Thử đổi từ khóa, khu vực hoặc danh mục.
                </div>
            }
        </div>

        <div class="py-10 text-center text-xs text-slate-500">
            © @DateTime.Now.Year Booking • Dashboard kiểu marketplace
        </div>
    </div>
</div>

@section Scripts {
@if (TempData["SwalMessage"] != null)
{
<script>
  Swal.fire({
    icon: '@(TempData["SwalType"] ?? "info")',
    title: '@(TempData["SwalTitle"] ?? "Thông báo")',
    text: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(TempData["SwalMessage"]?.ToString() ?? "")),
    confirmButtonText: 'OK'
  });
</script>
}
}
