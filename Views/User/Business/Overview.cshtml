@model booking.ViewModels.BusinessOverviewVm

@{
    ViewData["Title"] = "Tổng quan doanh nghiệp";

    var avatarPlaceholder = Url.Content("~/images/placeholder-avatar.png");
    var servicePlaceholder = Url.Content("~/images/placeholder-service.png");

    var av = string.IsNullOrWhiteSpace(Model.Avatar) ? avatarPlaceholder : Url.Content(Model.Avatar);

    string Norm(string? s) => (s ?? "").Trim().ToLowerInvariant();

    string StatusVi(string? s) => Norm(s) switch
    {
        "active" => "Đang hoạt động",
        "pending" => "Chờ duyệt",
        "suspended" => "Tạm khóa",
        "rejected" => "Từ chối",
        _ => string.IsNullOrWhiteSpace(s) ? "—" : s!
    };

    string StatusBadge(string? s) => Norm(s) switch
    {
        "active" => "bg-emerald-50 text-emerald-700 ring-1 ring-emerald-100",
        "pending" => "bg-amber-50 text-amber-700 ring-1 ring-amber-100",
        "suspended" => "bg-slate-100 text-slate-700 ring-1 ring-slate-200",
        "rejected" => "bg-rose-50 text-rose-700 ring-1 ring-rose-100",
        _ => "bg-slate-100 text-slate-700 ring-1 ring-slate-200"
    };

    string PriceVnd(decimal v) =>
        string.Format(System.Globalization.CultureInfo.GetCultureInfo("vi-VN"), "{0:N0}đ", v);

    string TimeAgo(DateTime dt)
    {
        var span = DateTime.Now - dt;
        if (span.TotalMinutes < 1) return "vừa xong";
        if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes} phút trước";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours} giờ trước";
        if (span.TotalDays < 7) return $"{(int)span.TotalDays} ngày trước";
        return dt.ToString("dd/MM/yyyy");
    }

    string StarsText(int stars)
    {
        stars = Math.Clamp(stars, 0, 5);
        var filled = new string('★', stars);
        var empty = new string('☆', 5 - stars);
        return filled + empty;
    }

    var cats = Model.Categories ?? new List<string>();
    var top = Model.TopServices ?? new List<booking.Models.Service>();
    var reviews = Model.RecentReviews ?? new List<booking.ViewModels.BusinessOverviewVm.RecentReviewItemVm>();
    var groups = Model.ServiceReviewGroups ?? new List<booking.ViewModels.BusinessOverviewVm.ServiceReviewGroupVm>();
}

<div class="min-h-screen bg-slate-50">
    <!-- Top bar -->
    <div class="sticky top-0 z-30 border-b border-slate-200 bg-white/80 backdrop-blur">
        <div class="mx-auto max-w-6xl px-4 sm:px-6 py-4">
            <div class="flex items-center justify-between gap-4">
                <div class="min-w-0">
                    <div class="text-xs text-slate-500">Booking</div>
                    <div class="truncate text-lg sm:text-xl font-semibold text-slate-900">
                        Tổng quan doanh nghiệp
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <a asp-controller="User" asp-action="Index"
                       class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold text-slate-800 hover:bg-slate-50">
                        ← Quay lại khám phá
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="mx-auto max-w-6xl px-4 sm:px-6 py-6">
        <!-- Hero -->
        <div class="rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden">
            <div class="p-6 sm:p-8">
                <div class="flex flex-col gap-5 sm:flex-row sm:items-start sm:justify-between">
                    <div class="flex items-start gap-4 min-w-0">
                        <img src="@av"
                             class="h-14 w-14 rounded-3xl object-cover ring-1 ring-slate-200"
                             onerror="this.onerror=null;this.src='@avatarPlaceholder';" />

                        <div class="min-w-0">
                            <div class="flex flex-wrap items-center gap-2">
                                <div class="truncate text-2xl sm:text-3xl font-extrabold text-slate-900">
                                    @Model.FullName
                                </div>
                                <span class="rounded-full px-3 py-1 text-xs font-semibold @StatusBadge(Model.Status)">
                                    @StatusVi(Model.Status)
                                </span>
                            </div>

                            <div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-slate-600">
                                <span>⭐ <span class="font-semibold text-slate-900">@Model.AvgRating.ToString("0.0")</span></span>
                                <span>• <span class="font-semibold text-slate-900">@Model.TotalReviews</span> đánh giá</span>
                                <span>• <span class="font-semibold text-slate-900">@Model.ActiveServices</span>/<span class="font-semibold text-slate-900">@Model.TotalServices</span> dịch vụ đang mở</span>
                                <span>• <span class="font-semibold text-slate-900">@Model.StaffCount</span> nhân viên</span>
                            </div>

                            @if (cats.Any())
                            {
                                <div class="mt-3 flex flex-wrap gap-2">
                                    @foreach (var c in cats)
                                    {
                                        <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700 ring-1 ring-slate-200">
                                            @c
                                        </span>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <a href="#dich-vu"
                           class="inline-flex items-center justify-center rounded-2xl bg-slate-900 px-4 py-2.5 text-sm font-semibold text-white hover:bg-slate-800">
                            Xem dịch vụ
                        </a>

                        <a href="#reviews"
                           class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold text-slate-800 hover:bg-slate-50">
                            Xem review
                        </a>
                    </div>
                </div>

                <!-- KPI -->
                <div class="mt-6 grid grid-cols-2 gap-3 sm:grid-cols-6">
                    <div class="rounded-2xl border border-slate-200 p-4">
                        <div class="text-xs text-slate-500">Tổng booking</div>
                        <div class="mt-1 text-xl font-extrabold text-slate-900">@Model.TotalBookings</div>
                    </div>
                    <div class="rounded-2xl border border-slate-200 p-4">
                        <div class="text-xs text-slate-500">Chờ xác nhận</div>
                        <div class="mt-1 text-xl font-extrabold text-amber-700">@Model.PendingBookings</div>
                    </div>
                    <div class="rounded-2xl border border-slate-200 p-4">
                        <div class="text-xs text-slate-500">Đã xác nhận</div>
                        <div class="mt-1 text-xl font-extrabold text-indigo-700">@Model.ConfirmedBookings</div>
                    </div>
                    <div class="rounded-2xl border border-slate-200 p-4">
                        <div class="text-xs text-slate-500">Hoàn thành</div>
                        <div class="mt-1 text-xl font-extrabold text-emerald-700">@Model.CompletedBookings</div>
                    </div>
                    <div class="rounded-2xl border border-slate-200 p-4">
                        <div class="text-xs text-slate-500">Review hôm nay</div>
                        <div class="mt-1 text-xl font-extrabold text-slate-900">@Model.NewReviewsToday</div>
                    </div>
                    <div class="rounded-2xl border border-slate-200 p-4">
                        <div class="text-xs text-slate-500">Review 7 ngày</div>
                        <div class="mt-1 text-xl font-extrabold text-slate-900">@Model.NewReviews7d</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews gần nhất -->
        <div id="reviews" class="mt-8">
            <div class="flex items-end justify-between gap-3">
                <div>
                    <h2 class="text-base sm:text-lg font-semibold text-slate-900">Review gần nhất</h2>
                    <p class="mt-1 text-sm text-slate-600">Các review mới nhất của mọi dịch vụ thuộc doanh nghiệp.</p>
                </div>
            </div>

            @if (!reviews.Any())
            {
                <div class="mt-4 rounded-3xl border border-slate-200 bg-white p-6 text-sm text-slate-600">
                    Chưa có review nào.
                </div>
            }
            else
            {
                <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                    @foreach (var r in reviews)
                    {
                        var rav = string.IsNullOrWhiteSpace(r.ReviewerAvatar) ? avatarPlaceholder : Url.Content(r.ReviewerAvatar);

                        <div class="rounded-3xl border border-slate-200 bg-white p-5 shadow-sm hover:shadow-md transition">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex items-start gap-3 min-w-0">
                                    <img src="@rav"
                                         class="h-10 w-10 rounded-2xl object-cover ring-1 ring-slate-200"
                                         onerror="this.onerror=null;this.src='@avatarPlaceholder';" />
                                    <div class="min-w-0">
                                        <div class="truncate text-sm font-semibold text-slate-900">@r.ReviewerName</div>
                                        <div class="mt-0.5 text-xs text-slate-500 truncate">
                                            Dịch vụ: <span class="font-semibold text-slate-700">@r.ServiceName</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="text-right shrink-0">
                                    <div class="text-sm font-extrabold text-amber-600">@StarsText(r.Stars)</div>
                                    <div class="mt-0.5 text-xs text-slate-500">@TimeAgo(r.CreatedAt)</div>
                                </div>
                            </div>

                            @if (!string.IsNullOrWhiteSpace(r.Comment))
                            {
                                <div class="mt-3 text-sm text-slate-700 line-clamp-4">
                                    @r.Comment
                                </div>
                            }
                            else
                            {
                                <div class="mt-3 text-sm text-slate-500 italic">
                                    (Không có bình luận)
                                </div>
                            }

                            <div class="mt-4">
                                <a asp-controller="Services" asp-action="Details" asp-route-id="@r.ServiceId"
                                   class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-800 hover:bg-slate-50">
                                    Xem dịch vụ
                                </a>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- ✅ Accordion: review theo từng dịch vụ -->
        <div class="mt-8">
            <div class="flex items-end justify-between gap-3">
                <div>
                    <h2 class="text-base sm:text-lg font-semibold text-slate-900">Review theo từng dịch vụ</h2>
                    <p class="mt-1 text-sm text-slate-600">Bấm vào dịch vụ để xem review mới nhất của dịch vụ đó.</p>
                </div>
            </div>

            @if (!groups.Any())
            {
                <div class="mt-4 rounded-3xl border border-slate-200 bg-white p-6 text-sm text-slate-600">
                    Chưa có dữ liệu dịch vụ để nhóm review.
                </div>
            }
            else
            {
                <div class="mt-4 space-y-3">
                    @foreach (var g in groups)
                    {
                        var t = string.IsNullOrWhiteSpace(g.ServiceThumbnail) ? servicePlaceholder : Url.Content(g.ServiceThumbnail);

                        <details class="group rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden">
                            <summary class="cursor-pointer list-none p-5 hover:bg-slate-50">
                                <div class="flex items-center gap-4">
                                    <img src="@t"
                                         class="h-12 w-12 rounded-2xl object-cover ring-1 ring-slate-200"
                                         onerror="this.onerror=null;this.src='@servicePlaceholder';" />
                                    <div class="min-w-0 flex-1">
                                        <div class="flex items-center justify-between gap-3">
                                            <div class="truncate text-base font-semibold text-slate-900">@g.ServiceName</div>
                                            <div class="shrink-0 text-xs text-slate-600">
                                                ⭐ <span class="font-semibold text-slate-900">@g.Rating.ToString("0.0")</span>
                                                <span class="mx-1">•</span>
                                                <span class="font-semibold text-slate-900">@g.ReviewCount</span> review
                                            </div>
                                        </div>

                                        <div class="mt-1 flex items-center gap-2 text-xs text-slate-500">
                                            <span class="rounded-full bg-slate-100 px-2.5 py-1 ring-1 ring-slate-200">
                                                Bấm để xem review
                                            </span>
                                        </div>
                                    </div>

                                    <div class="shrink-0 text-slate-400 group-open:rotate-180 transition">
                                        ▼
                                    </div>
                                </div>
                            </summary>

                            <div class="border-t border-slate-200 p-5">
                                @if (g.Reviews == null || !g.Reviews.Any())
                                {
                                    <div class="text-sm text-slate-600">
                                        Dịch vụ này chưa có review.
                                    </div>
                                }
                                else
                                {
                                    <div class="space-y-4">
                                        @foreach (var r in g.Reviews)
                                        {
                                            var rav = string.IsNullOrWhiteSpace(r.ReviewerAvatar) ? avatarPlaceholder : Url.Content(r.ReviewerAvatar);

                                            <div class="rounded-2xl border border-slate-200 p-4">
                                                <div class="flex items-start justify-between gap-3">
                                                    <div class="flex items-start gap-3 min-w-0">
                                                        <img src="@rav"
                                                             class="h-9 w-9 rounded-2xl object-cover ring-1 ring-slate-200"
                                                             onerror="this.onerror=null;this.src='@avatarPlaceholder';" />
                                                        <div class="min-w-0">
                                                            <div class="truncate text-sm font-semibold text-slate-900">@r.ReviewerName</div>
                                                            <div class="mt-0.5 text-xs text-slate-500">@TimeAgo(r.CreatedAt)</div>
                                                        </div>
                                                    </div>

                                                    <div class="shrink-0 text-sm font-extrabold text-amber-600">
                                                        @StarsText(r.Stars)
                                                    </div>
                                                </div>

                                                @if (!string.IsNullOrWhiteSpace(r.Comment))
                                                {
                                                    <div class="mt-3 text-sm text-slate-700">
                                                        @r.Comment
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="mt-3 text-sm text-slate-500 italic">
                                                        (Không có bình luận)
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                }

                                <div class="mt-4 flex gap-2">
                                    <a asp-controller="Booking" asp-action="Create" asp-route-serviceId="@g.ServiceId"
                                       class="inline-flex items-center justify-center rounded-2xl bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-indigo-700 shadow-sm">
                                        Đặt dịch vụ này
                                    </a>

                                    <a asp-controller="Services" asp-action="Details" asp-route-id="@g.ServiceId"
                                       class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold text-slate-800 hover:bg-slate-50">
                                        Xem chi tiết
                                    </a>
                                </div>
                            </div>
                        </details>
                    }
                </div>
            }
        </div>

        <!-- Dịch vụ nổi bật -->
        <div id="dich-vu" class="mt-8">
            <div class="flex items-end justify-between gap-3">
                <div>
                    <h2 class="text-base sm:text-lg font-semibold text-slate-900">Dịch vụ của doanh nghiệp</h2>
                    <p class="mt-1 text-sm text-slate-600">
                        Hiển thị các dịch vụ nổi bật (top rating/review).
                    </p>
                </div>
            </div>

            @if (!top.Any())
            {
                <div class="mt-4 rounded-3xl border border-slate-200 bg-white p-6 text-sm text-slate-600">
                    Doanh nghiệp này chưa có dịch vụ để hiển thị.
                </div>
            }
            else
            {
                <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                    @foreach (var s in top)
                    {
                        var thumb = string.IsNullOrWhiteSpace(s.Thumbnail) ? servicePlaceholder : Url.Content(s.Thumbnail);

                        <div class="rounded-3xl border border-slate-200 bg-white shadow-sm hover:shadow-md transition overflow-hidden">
                            <div class="relative aspect-[16/10] bg-slate-100">
                                <img src="@thumb"
                                     class="h-full w-full object-cover"
                                     loading="lazy"
                                     onerror="this.onerror=null;this.src='@servicePlaceholder';" />
                            </div>

                            <div class="p-5">
                                <div class="truncate text-base font-semibold text-slate-900">@s.Name</div>

                                <div class="mt-1 flex flex-wrap items-center gap-2 text-xs text-slate-500">
                                    <span>• @s.DurationMinutes phút</span>
                                    @if (!string.IsNullOrWhiteSpace(s.Location))
                                    {
                                        <span>• @s.Location</span>
                                    }
                                </div>

                                <div class="mt-4 flex items-center justify-between">
                                    <div>
                                        <div class="text-lg font-bold text-slate-900">@PriceVnd(s.Price)</div>
                                        <div class="mt-1 text-xs text-slate-500">Giá từ</div>
                                    </div>

                                    <div class="text-right">
                                        <div class="text-sm font-semibold text-slate-900">⭐ @s.Rating.ToString("0.0")</div>
                                        <div class="mt-1 text-xs text-slate-500">@s.ReviewCount đánh giá</div>
                                    </div>
                                </div>

                                <div class="mt-5 flex gap-2">
                                    <a asp-controller="Booking" asp-action="Create" asp-route-serviceId="@s.Id"
                                       class="flex-1 inline-flex items-center justify-center rounded-2xl bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-indigo-700 shadow-sm @(s.IsActive ? "" : "pointer-events-none opacity-60")">
                                        Đặt ngay
                                    </a>

                                    <a asp-controller="Services" asp-action="Details" asp-route-id="@s.Id"
                                       class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white px-3 py-2.5 text-sm font-semibold text-slate-800 hover:bg-slate-50">
                                        Chi tiết
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <div class="py-10 text-center text-xs text-slate-500">
            © @DateTime.Now.Year Booking • Trang tổng quan doanh nghiệp
        </div>
    </div>
</div>
